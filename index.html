<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000000">
  <title>Ghost Overlay Camera</title>
  <link rel="manifest" href="manifest.json">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', 'Helvetica Neue', sans-serif;
      color: #fff;
      touch-action: none;
    }

    /* ===== PERMISSION SCREEN ===== */
    #permission-screen {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #000;
      z-index: 100;
      padding: 40px;
      text-align: center;
    }
    #permission-screen.hidden { display: none; }

    .perm-icon {
      width: 80px;
      height: 80px;
      border-radius: 20px;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      margin-bottom: 24px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .perm-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 12px;
    }

    .perm-desc {
      font-size: 15px;
      color: rgba(255,255,255,0.6);
      margin-bottom: 32px;
      line-height: 1.5;
      max-width: 300px;
    }

    .perm-btn {
      background: #fff;
      color: #000;
      border: none;
      padding: 16px 48px;
      border-radius: 14px;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s;
    }
    .perm-btn:active { transform: scale(0.96); }

    .perm-error {
      color: #ff6b6b;
      margin-top: 16px;
      font-size: 14px;
      display: none;
    }

    /* ===== CAMERA VIEW ===== */
    #camera-container {
      position: fixed;
      inset: 0;
      background: #000;
    }
    #camera-container.hidden { display: none; }

    #camera-video {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* ===== GHOST OVERLAY ===== */
    #ghost-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      z-index: 10;
    }

    #ghost-overlay img {
      max-width: 92%;
      max-height: 60%;
      object-fit: contain;
      opacity: 0.45;
      filter: drop-shadow(0 0 8px rgba(100, 200, 255, 0.3));
      transition: opacity 0.3s ease;
    }

    /* ===== TOP BAR ===== */
    .top-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: env(safe-area-inset-top, 20px) 20px 12px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, transparent 100%);
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-top: max(env(safe-area-inset-top, 20px), 44px);
    }

    .shot-label {
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 8px 18px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.5px;
      border: 1px solid rgba(255,255,255,0.15);
    }

    .opacity-control {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 6px 14px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.15);
    }

    .opacity-control label {
      font-size: 12px;
      color: rgba(255,255,255,0.7);
    }

    .opacity-slider {
      -webkit-appearance: none;
      width: 80px;
      height: 4px;
      border-radius: 2px;
      background: rgba(255,255,255,0.2);
      outline: none;
    }

    .opacity-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #fff;
      cursor: pointer;
    }

    /* ===== BOTTOM CONTROLS ===== */
    .bottom-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 16px 20px;
      padding-bottom: max(env(safe-area-inset-bottom, 20px), 30px);
      background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);
      z-index: 20;
    }

    /* Shot selector */
    .shot-selector {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .shot-selector::-webkit-scrollbar { display: none; }

    .shot-btn {
      flex-shrink: 0;
      padding: 10px 18px;
      border-radius: 12px;
      border: 1.5px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      color: rgba(255,255,255,0.7);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .shot-btn.active {
      background: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.5);
      color: #fff;
      font-weight: 600;
    }

    /* Capture button */
    .capture-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 40px;
    }

    .capture-btn {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      border: 4px solid rgba(255,255,255,0.9);
      background: transparent;
      cursor: pointer;
      position: relative;
      transition: transform 0.1s;
    }
    .capture-btn:active { transform: scale(0.92); }

    .capture-btn::after {
      content: '';
      position: absolute;
      inset: 4px;
      border-radius: 50%;
      background: rgba(255,255,255,0.9);
      transition: opacity 0.15s;
    }

    .capture-btn.capturing::after {
      opacity: 0.5;
    }

    .switch-cam-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      color: #fff;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .gallery-btn {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      border: 2px solid rgba(255,255,255,0.3);
      background-size: cover;
      background-position: center;
      cursor: pointer;
      overflow: hidden;
    }
    .gallery-btn.empty {
      background: rgba(255,255,255,0.08);
    }

    /* ===== FLASH ANIMATION ===== */
    .flash {
      position: fixed;
      inset: 0;
      background: #fff;
      opacity: 0;
      z-index: 50;
      pointer-events: none;
      transition: opacity 0.08s;
    }
    .flash.active { opacity: 0.8; }

    /* ===== GALLERY / REVIEW ===== */
    #gallery-screen {
      position: fixed;
      inset: 0;
      background: #000;
      z-index: 60;
      display: none;
      flex-direction: column;
    }
    #gallery-screen.visible { display: flex; }

    .gallery-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: max(env(safe-area-inset-top, 20px), 44px) 20px 12px;
      background: rgba(0,0,0,0.9);
    }

    .gallery-back {
      background: none;
      border: none;
      color: #007AFF;
      font-size: 17px;
      cursor: pointer;
      padding: 8px;
    }

    .gallery-title {
      font-size: 17px;
      font-weight: 600;
    }

    .gallery-clear {
      background: none;
      border: none;
      color: #ff6b6b;
      font-size: 15px;
      cursor: pointer;
      padding: 8px;
    }

    .gallery-grid {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      align-content: start;
    }

    .gallery-item {
      aspect-ratio: 3/4;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      background: #111;
    }

    .gallery-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .gallery-item .shot-tag {
      position: absolute;
      bottom: 8px;
      left: 8px;
      background: rgba(0,0,0,0.7);
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
    }

    .gallery-empty {
      grid-column: 1 / -1;
      text-align: center;
      padding: 60px 20px;
      color: rgba(255,255,255,0.4);
    }

    /* ===== COUNTER BADGE ===== */
    .counter-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      background: #007AFF;
      color: #fff;
      font-size: 11px;
      font-weight: 700;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ===== TOAST ===== */
    .toast {
      position: fixed;
      top: max(env(safe-area-inset-top, 20px), 50px);
      left: 50%;
      transform: translateX(-50%) translateY(-100px);
      background: rgba(0,0,0,0.85);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      z-index: 90;
      pointer-events: none;
      transition: transform 0.3s ease;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .toast.show {
      transform: translateX(-50%) translateY(0);
    }

    /* ===== DOWNLOAD OVERLAY ===== */
    .download-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      z-index: 80;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .download-overlay.visible { display: flex; }

    .download-card {
      background: #1c1c1e;
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      max-width: 300px;
      width: 90%;
    }

    .download-card h3 {
      margin-bottom: 8px;
      font-size: 20px;
    }

    .download-card p {
      color: rgba(255,255,255,0.5);
      font-size: 14px;
      margin-bottom: 24px;
    }

    .download-card button {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 10px;
    }

    .btn-download {
      background: #007AFF;
      color: #fff;
    }

    .btn-cancel {
      background: rgba(255,255,255,0.1);
      color: #fff;
    }
  </style>
</head>
<body>

  <!-- PERMISSION SCREEN -->
  <div id="permission-screen">
    <div class="perm-icon">üì∑</div>
    <div class="perm-title">Ghost Overlay Camera</div>
    <div class="perm-desc">
      Guided vehicle photography with transparent overlays. 
      Camera access is needed to capture photos.
    </div>
    <button class="perm-btn" id="start-btn">Enable Camera</button>
    <div class="perm-error" id="perm-error">Camera access denied. Please allow camera in your browser settings.</div>
  </div>

  <!-- CAMERA VIEW -->
  <div id="camera-container" class="hidden">
    <video id="camera-video" autoplay playsinline muted></video>

    <!-- Ghost Overlay -->
    <div id="ghost-overlay">
      <img id="overlay-img" src="front_left_45.png" alt="overlay">
    </div>

    <!-- Top Bar -->
    <div class="top-bar">
      <div class="shot-label" id="shot-label">FRONT LEFT 45¬∞</div>
      <div class="opacity-control">
        <label>Ghost</label>
        <input type="range" class="opacity-slider" id="opacity-slider" min="10" max="80" value="45">
      </div>
    </div>

    <!-- Bottom Bar -->
    <div class="bottom-bar">
      <div class="shot-selector" id="shot-selector">
        <button class="shot-btn active" data-shot="front_left_45" data-label="FRONT LEFT 45¬∞">Front 45¬∞</button>
        <button class="shot-btn" data-shot="side_driver" data-label="SIDE PROFILE">Side</button>
        <button class="shot-btn" data-shot="rear_center" data-label="REAR VIEW">Rear</button>
      </div>
      <div class="capture-row">
        <div class="gallery-btn empty" id="gallery-btn" style="position:relative;">
          <span class="counter-badge" id="counter-badge" style="display:none;">0</span>
        </div>
        <button class="capture-btn" id="capture-btn"></button>
        <button class="switch-cam-btn" id="switch-cam-btn">üîÑ</button>
      </div>
    </div>

    <!-- Flash -->
    <div class="flash" id="flash"></div>
  </div>

  <!-- GALLERY SCREEN -->
  <div id="gallery-screen">
    <div class="gallery-header">
      <button class="gallery-back" id="gallery-back">‚Üê Back</button>
      <div class="gallery-title">Captured Photos</div>
      <button class="gallery-clear" id="gallery-clear">Clear All</button>
    </div>
    <div class="gallery-grid" id="gallery-grid">
      <div class="gallery-empty">No photos captured yet</div>
    </div>
  </div>

  <!-- TOAST -->
  <div class="toast" id="toast"></div>

  <!-- Hidden canvas for capture -->
  <canvas id="capture-canvas" style="display:none;"></canvas>

  <script>
    // ===== STATE =====
    const state = {
      stream: null,
      facingMode: 'environment',  // rear camera
      currentShot: 'front_left_45',
      currentLabel: 'FRONT LEFT 45¬∞',
      photos: [],  // { dataUrl, shotName, timestamp }
    };

    // ===== ELEMENTS =====
    const els = {
      permScreen: document.getElementById('permission-screen'),
      camContainer: document.getElementById('camera-container'),
      video: document.getElementById('camera-video'),
      overlayImg: document.getElementById('overlay-img'),
      shotLabel: document.getElementById('shot-label'),
      opacitySlider: document.getElementById('opacity-slider'),
      shotSelector: document.getElementById('shot-selector'),
      captureBtn: document.getElementById('capture-btn'),
      switchCamBtn: document.getElementById('switch-cam-btn'),
      galleryBtn: document.getElementById('gallery-btn'),
      counterBadge: document.getElementById('counter-badge'),
      flash: document.getElementById('flash'),
      galleryScreen: document.getElementById('gallery-screen'),
      galleryGrid: document.getElementById('gallery-grid'),
      galleryBack: document.getElementById('gallery-back'),
      galleryClear: document.getElementById('gallery-clear'),
      toast: document.getElementById('toast'),
      canvas: document.getElementById('capture-canvas'),
      startBtn: document.getElementById('start-btn'),
      permError: document.getElementById('perm-error'),
    };

    // ===== CAMERA =====
    async function startCamera() {
      try {
        if (state.stream) {
          state.stream.getTracks().forEach(t => t.stop());
        }

        const constraints = {
          video: {
            facingMode: state.facingMode,
            width: { ideal: 1920 },
            height: { ideal: 1080 },
          },
          audio: false,
        };

        state.stream = await navigator.mediaDevices.getUserMedia(constraints);
        els.video.srcObject = state.stream;
        await els.video.play();

        // Show camera view
        els.permScreen.classList.add('hidden');
        els.camContainer.classList.remove('hidden');

      } catch (err) {
        console.error('Camera error:', err);
        els.permError.style.display = 'block';
        els.permError.textContent = 
          err.name === 'NotAllowedError' 
            ? 'Camera access denied. Please allow camera in your browser settings and reload.'
            : `Camera error: ${err.message}`;
      }
    }

    // ===== SHOT SELECTION =====
    function selectShot(shotName, label) {
      state.currentShot = shotName;
      state.currentLabel = label;
      els.overlayImg.src = `${shotName}.png`;
      els.shotLabel.textContent = label;

      // Update active button
      document.querySelectorAll('.shot-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.shot === shotName);
      });
    }

    // ===== OPACITY =====
    function updateOpacity(val) {
      els.overlayImg.style.opacity = val / 100;
    }

    // ===== CAPTURE =====
    async function capturePhoto() {
      const video = els.video;
      const canvas = els.canvas;

      // Set canvas to video resolution
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0);

      // Flash effect
      els.flash.classList.add('active');
      els.captureBtn.classList.add('capturing');
      
      // Haptic feedback if available
      if (navigator.vibrate) navigator.vibrate(50);

      setTimeout(() => {
        els.flash.classList.remove('active');
        els.captureBtn.classList.remove('capturing');
      }, 150);

      // Save photo
      const dataUrl = canvas.toDataURL('image/jpeg', 0.92);
      state.photos.push({
        dataUrl,
        shotName: state.currentLabel,
        timestamp: new Date().toLocaleTimeString(),
      });

      updateGalleryBtn();
      showToast(`üì∏ ${state.currentLabel} captured`);

      // Auto-advance to next shot
      autoAdvance();
    }

    function autoAdvance() {
      const shots = ['front_left_45', 'side_driver', 'rear_center'];
      const labels = ['FRONT LEFT 45¬∞', 'SIDE PROFILE', 'REAR VIEW'];
      const idx = shots.indexOf(state.currentShot);
      if (idx < shots.length - 1) {
        setTimeout(() => selectShot(shots[idx + 1], labels[idx + 1]), 500);
      }
    }

    // ===== GALLERY =====
    function updateGalleryBtn() {
      const count = state.photos.length;
      if (count > 0) {
        const last = state.photos[count - 1];
        els.galleryBtn.style.backgroundImage = `url(${last.dataUrl})`;
        els.galleryBtn.classList.remove('empty');
        els.counterBadge.textContent = count;
        els.counterBadge.style.display = 'flex';
      } else {
        els.galleryBtn.style.backgroundImage = '';
        els.galleryBtn.classList.add('empty');
        els.counterBadge.style.display = 'none';
      }
    }

    function showGallery() {
      els.galleryScreen.classList.add('visible');
      renderGallery();
    }

    function hideGallery() {
      els.galleryScreen.classList.remove('visible');
    }

    function renderGallery() {
      if (state.photos.length === 0) {
        els.galleryGrid.innerHTML = '<div class="gallery-empty">No photos captured yet</div>';
        return;
      }

      els.galleryGrid.innerHTML = state.photos.map((p, i) => `
        <div class="gallery-item" onclick="downloadPhoto(${i})">
          <img src="${p.dataUrl}" alt="${p.shotName}">
          <div class="shot-tag">${p.shotName}</div>
        </div>
      `).join('');
    }

    function clearGallery() {
      if (confirm('Clear all captured photos?')) {
        state.photos = [];
        updateGalleryBtn();
        renderGallery();
        showToast('Gallery cleared');
      }
    }

    function downloadPhoto(index) {
      const photo = state.photos[index];
      const link = document.createElement('a');
      link.href = photo.dataUrl;
      link.download = `${photo.shotName.replace(/\s+/g, '_')}_${Date.now()}.jpg`;
      link.click();
      showToast('üì• Photo saved');
    }

    // ===== SWITCH CAMERA =====
    function switchCamera() {
      state.facingMode = state.facingMode === 'environment' ? 'user' : 'environment';
      startCamera();
      showToast(state.facingMode === 'environment' ? 'üì∑ Rear camera' : 'ü§≥ Front camera');
    }

    // ===== TOAST =====
    function showToast(msg) {
      els.toast.textContent = msg;
      els.toast.classList.add('show');
      setTimeout(() => els.toast.classList.remove('show'), 2000);
    }

    // ===== EVENT LISTENERS =====
    els.startBtn.addEventListener('click', startCamera);

    els.shotSelector.addEventListener('click', (e) => {
      const btn = e.target.closest('.shot-btn');
      if (btn) selectShot(btn.dataset.shot, btn.dataset.label);
    });

    els.opacitySlider.addEventListener('input', (e) => {
      updateOpacity(e.target.value);
    });

    els.captureBtn.addEventListener('click', capturePhoto);
    els.switchCamBtn.addEventListener('click', switchCamera);
    els.galleryBtn.addEventListener('click', showGallery);
    els.galleryBack.addEventListener('click', hideGallery);
    els.galleryClear.addEventListener('click', clearGallery);

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space') { e.preventDefault(); capturePhoto(); }
      if (e.code === 'KeyF') switchCamera();
    });

    // Initialize opacity
    updateOpacity(els.opacitySlider.value);
  </script>
</body>
</html>
