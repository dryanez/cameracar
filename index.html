<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover, maximum-scale=1, interactive-widget=resizes-content">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#000000">
  <title>C√°mara con Superposici√≥n</title>
  <link rel="manifest" href="manifest.json">
  <!-- TensorFlow.js + COCO-SSD for vehicle detection -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3/dist/coco-ssd.min.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html, body {
      width:100%; height:100%; overflow:hidden;
      background:#000;
      font-family:-apple-system,BlinkMacSystemFont,'SF Pro','Helvetica Neue',sans-serif;
      color:#fff; touch-action:manipulation;
      /* CSS custom prop set by JS from visualViewport */
      --app-h: 100vh;
    }

    /* ===== PERMISSION ===== */
    #perm { position:fixed; top:0; left:0; width:100%; height:var(--app-h, 100vh); display:flex; flex-direction:column; align-items:center; justify-content:center; background:#000; z-index:100; padding:40px; text-align:center; }
    #perm.hidden { display:none; }
    .perm-icon { font-size:48px; margin-bottom:20px; }
    .perm-title { font-size:26px; font-weight:700; margin-bottom:10px; }
    .perm-sub { font-size:15px; color:rgba(255,255,255,0.5); margin-bottom:36px; max-width:280px; line-height:1.5; }
    .perm-btn { background:#fff; color:#000; border:none; padding:16px 56px; border-radius:14px; font-size:17px; font-weight:600; cursor:pointer; }
    .perm-btn:active { transform:scale(0.96); }
    #perm-err { color:#ff6b6b; margin-top:16px; font-size:13px; display:none; }

    /* ===== CAMERA ===== */
    #cam { position:fixed; top:0; left:0; width:100%; height:var(--app-h, 100vh); background:#000; overflow:hidden; }
    #cam.hidden { display:none; }
    #video { position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; }

    /* ===== GHOST OVERLAY ‚Äî BIG ===== */
    #ghost { position:absolute; top:0; left:0; right:0; bottom:0; display:flex; align-items:center; justify-content:center; pointer-events:none; z-index:10; padding:0; }
    #ghost img {
      width: 100%;
      height: calc(var(--app-h, 100vh) * 0.65);
      object-fit: contain;
      opacity: 0.45;
      filter: drop-shadow(0 0 6px rgba(200,160,60,0.4));
      transition: opacity 0.3s, filter 0.3s;
      margin-top: -40px;
    }

    /* Alignment frame around overlay */
    #align-frame {
      position:absolute; top:50%; left:50%; z-index:11;
      width: 75%; max-width:420px;
      height: calc(var(--app-h, 100vh) * 0.50);
      transform: translate(-50%, -58%);
      border: 3px solid rgba(255,60,60,0.6);
      border-radius: 18px;
      pointer-events:none;
      transition: border-color 0.4s, box-shadow 0.4s;
    }
    /* Corner brackets */
    #align-frame::before, #align-frame::after {
      content:''; position:absolute; width:28px; height:28px;
      border-color:inherit; border-style:solid;
    }
    #align-frame::before { top:-2px; left:-2px; border-width:4px 0 0 4px; border-radius:14px 0 0 0; }
    #align-frame::after { top:-2px; right:-2px; border-width:4px 4px 0 0; border-radius:0 14px 0 0; }
    .corner-bl, .corner-br {
      position:absolute; width:28px; height:28px;
      border-color:inherit; border-style:solid; pointer-events:none;
    }
    .corner-bl { bottom:-2px; left:-2px; border-width:0 0 4px 4px; border-radius:0 0 0 14px; }
    .corner-br { bottom:-2px; right:-2px; border-width:0 4px 4px 0; border-radius:0 0 14px 0; }

    /* States */
    #align-frame.seeking { border-color: rgba(255,60,60,0.6); }
    #align-frame.close { border-color: rgba(255,200,40,0.8); box-shadow: 0 0 20px rgba(255,200,40,0.15); }
    #align-frame.locked {
      border-color: rgba(40,220,80,0.9);
      box-shadow: 0 0 30px rgba(40,220,80,0.2);
      animation: pulse-green 1s ease infinite;
    }
    @keyframes pulse-green {
      0%,100% { box-shadow: 0 0 20px rgba(40,220,80,0.15); }
      50% { box-shadow: 0 0 40px rgba(40,220,80,0.35); }
    }
    #align-frame.captured {
      border-color: rgba(40,220,80,1);
      box-shadow: 0 0 50px rgba(40,220,80,0.5);
    }

    /* Hold-still progress ring */
    #hold-progress {
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      width:90px; height:90px; z-index:16; pointer-events:none;
      opacity:0; transition:opacity 0.3s;
    }
    #hold-progress.visible { opacity:1; }
    #hold-progress svg { width:100%; height:100%; transform:rotate(-90deg); }
    #hold-progress circle {
      fill:none; stroke-width:4; cx:45; cy:45; r:40;
    }
    .prog-bg { stroke:rgba(255,255,255,0.15); }
    .prog-fg { stroke:rgba(40,220,80,0.9); stroke-dasharray:251.3; stroke-dashoffset:251.3; stroke-linecap:round; transition:stroke-dashoffset 0.1s linear; }

    /* ===== LANDSCAPE MODE (PHONE) ===== */
    /* Hide side panels in portrait */
    .land-left, .land-right { display:none; }
    @media (orientation: landscape) {
      #ghost img {
        height: calc(var(--app-h, 100vh) * 0.85);
        width: 55%;
        margin-top: 0;
      }
      #align-frame {
        width: 50%; height: calc(var(--app-h, 100vh) * 0.75);
        transform: translate(-50%, -52%);
      }
      .top-bar { padding-top:4px !important; padding-bottom:2px; z-index:22; }
      .top-close { font-size:20px; margin-left:60px; }
      .top-right { flex-direction:row; gap:6px; }
      .top-icon-btn { font-size:16px; padding:4px; }

      /* Bottom panel becomes a thin center strip with just capture + gallery */
      .bottom-panel {
        position:absolute; bottom:0; left:50%; right:auto; top:auto;
        transform:translateX(-50%);
        width:auto; min-width:160px; background:transparent !important;
        padding:0 0 max(env(safe-area-inset-bottom,4px),4px) !important;
        display:flex; flex-direction:column; align-items:center;
        justify-content:center;
        z-index:20;
      }

      /* Hide carousel and tabs from bottom panel ‚Äî they go to side panels */
      .shot-carousel { display:none !important; }
      .cat-tabs { display:none !important; }

      .capture-row { padding:2px 0; gap:14px; justify-content:center; }
      .cap-btn { width:52px; height:52px; border-width:3px; }
      .cap-btn::after { inset:3px; }
      .gallery-preview { width:34px; height:34px; border-radius:8px; }
      .side-btn { width:34px; height:34px; font-size:14px; }
      .gal-badge { width:14px; height:14px; font-size:8px; top:-3px; right:-3px; }

      /* LEFT SIDE PANEL ‚Äî category tabs */
      .land-left {
        display:flex !important;
        position:absolute;
        left:max(env(safe-area-inset-left, 0px), 4px);
        top:50%;
        transform:translateY(-50%);
        z-index:30;
        flex-direction:column; align-items:stretch; gap:2px;
        padding:8px 6px;
        background:rgba(0,0,0,0.75);
        border-radius:0 14px 14px 0;
        pointer-events:auto;
      }
      .land-left .lt-btn {
        writing-mode:horizontal-tb;
        background:none; border:none; color:rgba(255,255,255,0.55);
        font-size:12px; font-weight:500; cursor:pointer;
        padding:10px 14px; white-space:nowrap; position:relative;
        border-radius:8px; transition:all 0.2s;
        pointer-events:auto;
        -webkit-tap-highlight-color:rgba(255,255,255,0.1);
      }
      .land-left .lt-btn:active {
        background:rgba(255,255,255,0.1);
      }
      .land-left .lt-btn.active {
        color:#e74c3c; font-weight:700;
        background:rgba(231,76,60,0.15);
      }

      /* RIGHT SIDE PANEL ‚Äî shot thumbnails */
      .land-right {
        display:flex !important;
        position:absolute; right:0; top:50%;
        transform:translateY(-50%);
        z-index:25;
        flex-direction:column; align-items:center; gap:5px;
        padding:6px 5px;
        background:linear-gradient(to left, rgba(0,0,0,0.7) 60%, transparent 100%);
        border-radius:12px 0 0 12px;
        max-height: calc(var(--app-h, 100vh) - 40px);
        overflow-y:auto; scrollbar-width:none;
      }
      .land-right::-webkit-scrollbar { display:none; }
      .land-right .lr-thumb {
        flex-shrink:0; width:36px; height:36px; border-radius:50%;
        background:#1c1c1e; border:2px solid rgba(255,255,255,0.12);
        overflow:hidden; cursor:pointer; transition:all 0.2s;
        display:flex; align-items:center; justify-content:center; padding:3px;
      }
      .land-right .lr-thumb img { width:100%; height:100%; object-fit:contain; filter:brightness(0.6) saturate(0.5); transition:filter 0.2s; }
      .land-right .lr-thumb.active {
        width:44px; height:44px; border:2px solid #fff;
        box-shadow:0 0 0 2px rgba(255,255,255,0.12);
      }
      .land-right .lr-thumb.active img { filter:brightness(1) saturate(1); }

      .align-prompt { bottom:80px; }
      .align-badge { padding:6px 16px; font-size:12px; }
      .align-arrows { font-size:16px; }
      .align-sub { font-size:11px; }
    }

    /* Extra compact for very short phones in landscape */
    @media (orientation: landscape) and (max-height: 400px) {
      .top-bar { padding:2px 10px !important; }
      .top-close { font-size:18px; }
      #ghost img { height: calc(var(--app-h, 100vh) * 0.88); width: 50%; margin-top: 0; }
      .cap-btn { width:42px; height:42px; }
      .gallery-preview, .side-btn { width:28px; height:28px; }
      .land-left .lt-btn { font-size:11px; padding:8px 10px; }
      .land-right .lr-thumb { width:30px; height:30px; padding:2px; }
      .land-right .lr-thumb.active { width:38px; height:38px; }
      .align-prompt { bottom:65px; }
    }

    /* ===== TOP BAR ===== */
    .top-bar {
      position:absolute; top:0; left:0; right:0;
      padding: env(safe-area-inset-top, 8px) 16px 10px;
      background:linear-gradient(to bottom, rgba(0,0,0,0.75) 0%, transparent 100%);
      z-index:20; display:flex; align-items:flex-start; justify-content:space-between;
    }
    .top-close { background:none; border:none; color:#fff; font-size:28px; cursor:pointer; padding:6px; line-height:1; }
    .top-right { display:flex; flex-direction:column; gap:14px; align-items:center; }
    .top-icon-btn { background:none; border:none; color:#fff; font-size:22px; cursor:pointer; padding:6px; opacity:0.7; }

    /* ===== ALIGNMENT PROMPT ===== */
    .align-prompt {
      position:absolute; left:0; right:0; z-index:15;
      bottom: 290px;
      display:flex; flex-direction:column; align-items:center; gap:6px;
      pointer-events:none;
      transition: opacity 0.3s;
    }
    .align-arrows {
      display:flex; gap:6px; font-size:22px; opacity:0.85;
      text-shadow: 0 1px 4px rgba(0,0,0,0.6);
    }
    .align-arrows .dir-arrow {
      display:inline-block; animation: nudge 1s ease infinite;
    }
    .align-arrows .dir-arrow.left { animation-name: nudge-left; }
    .align-arrows .dir-arrow.right { animation-name: nudge-right; }
    .align-arrows .dir-arrow.up { animation-name: nudge-up; }
    .align-arrows .dir-arrow.down { animation-name: nudge-down; }
    @keyframes nudge-left { 0%,100%{transform:translateX(0);} 50%{transform:translateX(-6px);} }
    @keyframes nudge-right { 0%,100%{transform:translateX(0);} 50%{transform:translateX(6px);} }
    @keyframes nudge-up { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-6px);} }
    @keyframes nudge-down { 0%,100%{transform:translateY(0);} 50%{transform:translateY(6px);} }
    .align-badge {
      backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px);
      padding:12px 28px; border-radius:14px; font-size:16px; font-weight:600;
      transition: background 0.4s;
    }
    .align-badge.seeking { background:rgba(255,60,60,0.7); }
    .align-badge.close { background:rgba(255,180,30,0.8); }
    .align-badge.locked { background:rgba(40,200,70,0.85); }
    .align-badge.captured { background:rgba(40,220,80,0.95); }
    .align-sub { font-size:13px; color:rgba(255,255,255,0.5); }

    /* ===== BOTTOM PANEL ===== */
    .bottom-panel {
      position:absolute; bottom:0; left:0; right:0; z-index:20;
      background:linear-gradient(to top, rgba(0,0,0,0.95) 55%, rgba(0,0,0,0.6) 85%, transparent 100%);
      padding:0 0 max(env(safe-area-inset-bottom,10px),10px);
    }

    /* Shot carousel */
    .shot-carousel {
      display:flex; gap:10px; justify-content:center; align-items:center;
      padding:14px 16px 14px; overflow-x:auto;
      scrollbar-width:none; -webkit-overflow-scrolling:touch;
    }
    .shot-carousel::-webkit-scrollbar { display:none; }

    .shot-thumb {
      flex-shrink:0; width:52px; height:52px; border-radius:50%;
      background:#1c1c1e; border:2px solid rgba(255,255,255,0.12);
      overflow:hidden; cursor:pointer; transition:all 0.2s ease;
      display:flex; align-items:center; justify-content:center; padding:5px;
    }
    .shot-thumb img { width:100%; height:100%; object-fit:contain; filter:brightness(0.65) saturate(0.6); transition:filter 0.2s; }
    .shot-thumb.active {
      width:66px; height:66px; border:3px solid #fff;
      box-shadow:0 0 0 3px rgba(255,255,255,0.12);
    }
    .shot-thumb.active img { filter:brightness(1) saturate(1); }

    /* Capture row */
    .capture-row { display:flex; align-items:center; justify-content:center; gap:32px; padding:4px 20px 8px; }

    .cap-btn {
      width:70px; height:70px; border-radius:50%;
      border:4px solid rgba(255,255,255,0.85); background:transparent;
      cursor:pointer; position:relative; transition:transform 0.1s;
    }
    .cap-btn::after { content:''; position:absolute; inset:4px; border-radius:50%; background:rgba(255,255,255,0.85); transition:opacity 0.1s; }
    .cap-btn:active { transform:scale(0.92); }
    .cap-btn.flash::after { opacity:0.3; }

    .side-btn {
      width:42px; height:42px; border-radius:50%; border:none;
      background:rgba(255,255,255,0.1); color:#fff; font-size:18px;
      cursor:pointer; display:flex; align-items:center; justify-content:center;
    }
    .gallery-preview {
      width:42px; height:42px; border-radius:10px;
      border:2px solid rgba(255,255,255,0.2); background:#111;
      background-size:cover; background-position:center;
      cursor:pointer; position:relative;
    }
    .gal-badge {
      position:absolute; top:-5px; right:-5px;
      background:#007AFF; color:#fff; font-size:10px; font-weight:700;
      width:18px; height:18px; border-radius:50%;
      display:none; align-items:center; justify-content:center;
    }

    /* Category tabs */
    .cat-tabs {
      display:flex; justify-content:center; align-items:center;
      padding:8px 12px 2px; gap:0;
    }
    .cat-tab {
      padding:7px 18px; border:none; background:none;
      color:rgba(255,255,255,0.35); font-size:14px; font-weight:500;
      cursor:pointer; white-space:nowrap; position:relative; transition:color 0.2s;
    }
    .cat-tab.active { color:#e74c3c; font-weight:600; }
    .cat-tab.active::after {
      content:''; position:absolute; bottom:0; left:25%; right:25%;
      height:2px; background:#e74c3c; border-radius:1px;
    }

    /* ===== FLASH ===== */
    .flash-screen { position:fixed; top:0; left:0; width:100%; height:var(--app-h, 100vh); background:#fff; opacity:0; z-index:50; pointer-events:none; transition:opacity 0.08s; }
    .flash-screen.on { opacity:0.7; }

    /* ===== GALLERY ===== */
    #gallery { position:fixed; top:0; left:0; width:100%; height:var(--app-h, 100vh); background:#000; z-index:60; display:none; flex-direction:column; }
    #gallery.visible { display:flex; }
    .gh { display:flex; align-items:center; justify-content:space-between; padding:max(env(safe-area-inset-top,16px),44px) 16px 12px; background:rgba(0,0,0,0.95); }
    .gh button { background:none; border:none; font-size:16px; cursor:pointer; padding:8px; }
    .gh .back { color:#007AFF; }
    .gh .title { font-size:17px; font-weight:600; color:#fff; }
    .gh .clear { color:#ff6b6b; }
    .gg { flex:1; overflow-y:auto; padding:8px; display:grid; grid-template-columns:repeat(2,1fr); gap:8px; align-content:start; }
    .gi { aspect-ratio:3/4; border-radius:12px; overflow:hidden; position:relative; background:#111; cursor:pointer; }
    .gi img { width:100%; height:100%; object-fit:cover; }
    .gi .tag { position:absolute; bottom:8px; left:8px; background:rgba(0,0,0,0.7); padding:4px 10px; border-radius:6px; font-size:11px; }
    .ge { grid-column:1/-1; text-align:center; padding:60px; color:rgba(255,255,255,0.3); font-size:15px; }

    /* ===== TOAST ===== */
    .toast {
      position:fixed; top:max(env(safe-area-inset-top,16px),50px); left:50%;
      transform:translateX(-50%) translateY(-100px);
      background:rgba(0,0,0,0.85); backdrop-filter:blur(10px);
      padding:12px 24px; border-radius:12px; font-size:14px; font-weight:500;
      z-index:90; pointer-events:none; transition:transform 0.3s ease;
      border:1px solid rgba(255,255,255,0.1);
    }
    .toast.show { transform:translateX(-50%) translateY(0); }
  </style>
</head>
<body>

<!-- PERMISSION SCREEN -->
<div id="perm">
  <div class="perm-icon">üì∑</div>
  <div class="perm-title">C√°mara con Superposici√≥n</div>
  <div class="perm-sub">Fotograf√≠a guiada de veh√≠culos con superposiciones transparentes.</div>
  <button class="perm-btn" id="start-btn">üì∑ Iniciar C√°mara</button>
  <div id="perm-tip" style="margin-top:12px; font-size:12px; color:rgba(255,255,255,0.3);"></div>
  <div id="perm-err"></div>
</div>

<!-- CAMERA SCREEN -->
<div id="cam" class="hidden">
  <video id="video" autoplay playsinline muted></video>

  <div id="ghost">
    <img id="overlay-img" src="" alt="">
  </div>

  <!-- Alignment frame with corner brackets -->
  <div id="align-frame" class="seeking">
    <div class="corner-bl"></div>
    <div class="corner-br"></div>
  </div>

  <!-- Hold-still progress ring -->
  <div id="hold-progress">
    <svg viewBox="0 0 90 90">
      <circle class="prog-bg" cx="45" cy="45" r="40"/>
      <circle class="prog-fg" id="prog-circle" cx="45" cy="45" r="40"/>
    </svg>
  </div>

  <div class="top-bar">
    <button class="top-close" id="close-btn">&#x2715;</button>
    <div class="top-right">
      <button class="top-icon-btn" id="fs-btn" title="Pantalla completa">&#x26F6;</button>
      <button class="top-icon-btn" id="sw-btn" title="Cambiar">&#x1F504;</button>
    </div>
  </div>

  <div class="align-prompt">
    <div class="align-arrows" id="align-arrows"></div>
    <div class="align-badge" id="align-txt">Cargando IA...</div>
    <div class="align-sub" id="align-sub">Posiciona el veh√≠culo dentro de la superposici√≥n</div>
  </div>

  <div class="bottom-panel">
    <div class="shot-carousel" id="shots"></div>
    <div class="capture-row">
      <div class="gallery-preview" id="gp"><div class="gal-badge" id="gb">0</div></div>
      <button class="cap-btn" id="cap"></button>
      <button class="side-btn" id="sw2">&#x1F504;</button>
    </div>
    <div class="cat-tabs" id="tabs">
      <button class="cat-tab active" data-cat="sedan">Sed√°n</button>
      <button class="cat-tab" data-cat="suv">SUV</button>
      <button class="cat-tab" data-cat="truck">Camioneta</button>
      <button class="cat-tab" data-cat="interior">Interior</button>
    </div>
  </div>

  <!-- LANDSCAPE SIDE PANELS (hidden in portrait, visible in landscape via CSS) -->
  <div class="land-left" id="land-left"></div>
  <div class="land-right" id="land-right"></div>

  <div class="flash-screen" id="flash"></div>
</div>

<!-- GALLERY -->
<div id="gallery">
  <div class="gh">
    <button class="back" id="g-back">&larr; Volver</button>
    <span class="title">Fotos Capturadas</span>
    <button class="clear" id="g-clear">Borrar</button>
  </div>
  <div class="gg" id="g-grid"><div class="ge">Sin fotos a√∫n</div></div>
</div>

<div class="toast" id="toast"></div>

<!-- PWA Install Banner -->
<div id="pwa-banner" style="display:none; position:fixed; bottom:0; left:0; right:0; z-index:200; background:rgba(30,30,30,0.97); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px); padding:14px 16px; padding-bottom:max(env(safe-area-inset-bottom,14px),18px); border-top:1px solid rgba(255,255,255,0.1);">
  <div style="display:flex; align-items:center; gap:12px; max-width:500px; margin:0 auto;">
    <div style="font-size:28px;">üì∑</div>
    <div style="flex:1;">
      <div style="font-size:13px; font-weight:600;" id="pwa-title">Pantalla Completa</div>
      <div style="font-size:11px; color:rgba(255,255,255,0.5); margin-top:2px; line-height:1.4;" id="pwa-msg">Toca el bot√≥n ‚õ∂ o a√±ade a la pantalla de inicio para quitar las barras del navegador.</div>
    </div>
    <button id="pwa-dismiss" style="background:rgba(255,255,255,0.15); border:none; color:#fff; padding:7px 14px; border-radius:8px; font-size:12px; cursor:pointer; white-space:nowrap;">Entendido</button>
  </div>
</div>

<canvas id="cv" style="display:none"></canvas>

<script>
var OV = {
  sedan: [
    { f:'overlays/sedan/IMG_1199.png', l:'Lateral Izq' },
    { f:'overlays/sedan/IMG_1200.png', l:'Frontal' },
    { f:'overlays/sedan/IMG_1201.png', l:'Lateral Der' },
    { f:'overlays/sedan/IMG_1202.png', l:'Frontal Izq 45' },
    { f:'overlays/sedan/IMG_1203.png', l:'Trasera Lateral' },
    { f:'overlays/sedan/IMG_1204.png', l:'Trasera' },
    { f:'overlays/sedan/IMG_1205.png', l:'Superior' },
    { f:'overlays/sedan/IMG_1207-Photoroom.png', l:'Frontal Der 45' }
  ],
  suv: [
    { f:'overlays/suv/IMG_1212.png', l:'Lateral Izq' },
    { f:'overlays/suv/IMG_1213.png', l:'Frontal' },
    { f:'overlays/suv/IMG_1214.png', l:'Lateral Der' },
    { f:'overlays/suv/IMG_1215.png', l:'Trasera Lateral' },
    { f:'overlays/suv/IMG_1216.png', l:'Trasera' },
    { f:'overlays/suv/IMG_1217.png', l:'Superior' }
  ],
  truck: [
    { f:'overlays/truck/IMG_1218.png', l:'Lateral Izq' },
    { f:'overlays/truck/IMG_1219.png', l:'Frontal' },
    { f:'overlays/truck/IMG_1220.png', l:'Lateral Der' },
    { f:'overlays/truck/IMG_1221.png', l:'Frontal Izq 45' },
    { f:'overlays/truck/IMG_1222.png', l:'Trasera Lateral' },
    { f:'overlays/truck/IMG_1223.png', l:'Trasera' },
    { f:'overlays/truck/IMG_1224.png', l:'Superior' },
    { f:'overlays/truck/IMG_1225.png', l:'Frontal Der 45' }
  ],
  interior: [
    { f:'overlays/interior/IMG_1226.png', l:'Tablero' },
    { f:'overlays/interior/IMG_1227.png', l:'Volante' },
    { f:'overlays/interior/IMG_1228.png', l:'Consola Central' },
    { f:'overlays/interior/IMG_1229.png', l:'Asientos Traseros' },
    { f:'overlays/interior/IMG_1230.png', l:'Maletero' },
    { f:'overlays/interior/IMG_1231.png', l:'Panel Puerta' },
    { f:'overlays/interior/IMG_1232.png', l:'Indicadores' }
  ]
};

var S = { stream:null, face:'environment', cat:'sedan', idx:0, photos:[] };

function q(id) { return document.getElementById(id); }

// Camera
function startCam() {
  if (S.stream) { S.stream.getTracks().forEach(function(t){t.stop();}); S.stream = null; }

  // Use "exact" to force the correct camera (especially in PWA mode on Android)
  var constraints = {
    video: {
      facingMode: { exact: S.face },
      width: { ideal: 1920 },
      height: { ideal: 1080 }
    },
    audio: false
  };

  navigator.mediaDevices.getUserMedia(constraints)
  .then(onCamSuccess)
  .catch(function(e) {
    // "exact" failed ‚Äî try without "exact" as fallback
    var fallback = {
      video: {
        facingMode: S.face,
        width: { ideal: 1920 },
        height: { ideal: 1080 }
      },
      audio: false
    };
    return navigator.mediaDevices.getUserMedia(fallback).then(onCamSuccess);
  })
  .catch(function(e) {
    // Last resort: just get any camera
    return navigator.mediaDevices.getUserMedia({ video: true, audio: false }).then(onCamSuccess);
  })
  .catch(function(e) {
    var err = q('perm-err');
    err.style.display = 'block';
    if (e.name === 'NotAllowedError') {
      err.textContent = 'C√°mara denegada. Permite el acceso en ajustes y recarga.';
    } else {
      err.textContent = 'Error: ' + e.message;
    }
  });
}

function onCamSuccess(stream) {
  S.stream = stream;
  q('video').srcObject = stream;
  q('video').play();
  q('perm').classList.add('hidden');
  q('cam').classList.remove('hidden');
  loadCat(S.cat);

  // Check which camera we actually got and update S.face
  var track = stream.getVideoTracks()[0];
  if (track) {
    var settings = track.getSettings();
    if (settings.facingMode) {
      S.face = settings.facingMode;
    }
  }

  // Build landscape side panels
  syncLandPanels();

  // Start motion detection for alignment feedback
  startMotionDetection();
}

function flipCam() {
  S.face = (S.face === 'environment') ? 'user' : 'environment';
  startCam();
  toast(S.face === 'environment' ? 'C√°mara trasera' : 'C√°mara frontal');
}

// Category
function loadCat(cat) {
  S.cat = cat;
  S.idx = 0;
  var tabBtns = document.querySelectorAll('.cat-tab');
  for (var i = 0; i < tabBtns.length; i++) {
    if (tabBtns[i].dataset.cat === cat) { tabBtns[i].classList.add('active'); }
    else { tabBtns[i].classList.remove('active'); }
  }
  var shots = OV[cat];
  var html = '';
  for (var i = 0; i < shots.length; i++) {
    html += '<div class="shot-thumb' + (i === 0 ? ' active' : '') + '" data-i="' + i + '">';
    html += '<img src="' + shots[i].f + '" alt="' + shots[i].l + '">';
    html += '</div>';
  }
  q('shots').innerHTML = html;
  syncLandPanels();
  pickShot(0);
}

function pickShot(i) {
  var shots = OV[S.cat];
  if (i < 0 || i >= shots.length) return;
  S.idx = i;
  q('overlay-img').src = shots[i].f;
  var thumbs = document.querySelectorAll('.shot-thumb');
  for (var j = 0; j < thumbs.length; j++) {
    if (j === i) { thumbs[j].classList.add('active'); }
    else { thumbs[j].classList.remove('active'); }
  }
  // Sync landscape right-panel active state
  var lrThumbs = document.querySelectorAll('.lr-thumb');
  for (var j = 0; j < lrThumbs.length; j++) {
    if (j === i) { lrThumbs[j].classList.add('active'); }
    else { lrThumbs[j].classList.remove('active'); }
  }
  // Reset alignment state
  resetAlign();
  q('align-sub').textContent = shots[i].l;
}

// ===== LANDSCAPE SIDE PANELS =====
// Builds left (categories) and right (shots) panels for landscape mode
function syncLandPanels() {
  // LEFT: category buttons
  var cats = ['sedan', 'suv', 'truck', 'interior'];
  var labels = { sedan:'Sed√°n', suv:'SUV', truck:'Camioneta', interior:'Interior' };
  var leftHtml = '';
  for (var c = 0; c < cats.length; c++) {
    var cls = cats[c] === S.cat ? ' active' : '';
    leftHtml += '<button class="lt-btn' + cls + '" data-cat="' + cats[c] + '">' + labels[cats[c]] + '</button>';
  }
  q('land-left').innerHTML = leftHtml;

  // RIGHT: shot thumbnails for current category
  var shots = OV[S.cat];
  var rightHtml = '';
  for (var i = 0; i < shots.length; i++) {
    var cls = i === S.idx ? ' active' : '';
    rightHtml += '<div class="lr-thumb' + cls + '" data-i="' + i + '">';
    rightHtml += '<img src="' + shots[i].f + '" alt="' + shots[i].l + '">';
    rightHtml += '</div>';
  }
  q('land-right').innerHTML = rightHtml;
}

// Event delegation for landscape side panels
q('land-left').onclick = function(e) {
  var t = e.target;
  while (t && !t.classList.contains('lt-btn')) t = t.parentElement;
  if (t && t.dataset.cat) loadCat(t.dataset.cat);
};
q('land-right').onclick = function(e) {
  var t = e.target;
  while (t && !t.classList.contains('lr-thumb')) t = t.parentElement;
  if (t && t.dataset.i !== undefined) pickShot(parseInt(t.dataset.i));
};

// Capture
function capture() {
  S.autoCapturing = false; // stop auto-capture loop
  var v = q('video');
  var c = q('cv');
  c.width = v.videoWidth;
  c.height = v.videoHeight;
  c.getContext('2d').drawImage(v, 0, 0);
  q('flash').classList.add('on');
  q('cap').classList.add('flash');
  if (navigator.vibrate) navigator.vibrate([30, 50, 30]);

  // Show captured state
  setAlignState('captured');
  q('align-txt').textContent = '‚úì ¬°Capturada!';
  q('hold-progress').classList.remove('visible');

  setTimeout(function() {
    q('flash').classList.remove('on');
    q('cap').classList.remove('flash');
  }, 150);
  var url = c.toDataURL('image/jpeg', 0.92);
  var shot = OV[S.cat][S.idx];
  S.photos.push({ url:url, label:S.cat + ' - ' + shot.l, time:new Date().toLocaleTimeString() });
  updGal();
  toast('‚úì ' + shot.l);

  // ‚îÄ‚îÄ CRM Upload Bridge ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // If opened from the CRM with ?appraisal_id=xxx, upload this photo directly
  // to autodirectocrm.vercel.app so it's permanently saved to the vehicle.
  (function uploadToCRM(dataUrl, label) {
    var params = new URLSearchParams(window.location.search);
    var appraisalId = params.get('appraisal_id');
    if (!appraisalId) return; // standalone use ‚Äî no upload needed
    // Convert base64 dataURL ‚Üí Blob
    fetch(dataUrl)
      .then(function(r) { return r.blob(); })
      .then(function(blob) {
        var safeLabel = label.replace(/[^a-z0-9]/gi, '_');
        var filename  = safeLabel + '_' + Date.now() + '.jpg';
        var fd = new FormData();
        fd.append('file', blob, filename);
        fd.append('appraisal_id', appraisalId);
        return fetch('https://autodirectocrm.vercel.app/api/inspecciones/fotos', {
          method: 'POST',
          headers: { 'X-API-Key': 'mrcar2024' },
          body: fd
        });
      })
      .then(function(r) { return r.ok ? r.json() : Promise.reject(r.status); })
      .then(function(d) {
        if (d && d.ok) toast('‚òÅÔ∏è Guardada en veh√≠culo');
      })
      .catch(function(e) { console.warn('CRM upload failed', e); });
  })(url, S.cat + ' - ' + shot.l);
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  if (S.idx < OV[S.cat].length - 1) {
    setTimeout(function() { pickShot(S.idx + 1); }, 800);
  }
}

// ===== ALIGNMENT & VEHICLE DETECTION =====
// Uses COCO-SSD AI model to detect vehicles in the camera feed
// Compares detected vehicle position to overlay position for directional guidance
var A = {
  state: 'seeking',       // loading | seeking | close | locked | captured
  steadyStart: 0,
  holdTime: 2000,         // ms to hold in position before auto-capture
  autoCapturing: false,
  rafId: null,
  lastStateChange: 0,
  debounceMs: 300,
  // Vehicle detection
  model: null,            // COCO-SSD model
  modelReady: false,
  detecting: false,
  detectionInterval: null,
  // Position tracking
  positionHistory: [],    // recent position scores for smoothing
  posHistorySize: 5,
  // What classes count as vehicles
  vehicleClasses: ['car', 'truck', 'bus'],
  interiorClasses: ['car', 'truck', 'bus', 'chair', 'couch', 'dining table', 'cell phone'],
  // Thresholds for position matching (0-1 where 1 = perfect)
  thresholdClose: 0.45,   // position score above this = "close" (yellow)
  thresholdLock: 0.70     // position score above this = "locked" (green)
};

// Load the AI model
function loadDetectionModel() {
  q('align-txt').textContent = 'üß† Cargando IA...';
  q('align-txt').className = 'align-badge seeking';
  q('align-arrows').innerHTML = '';

  // Guard: make sure cocoSsd global exists (CDN loaded)
  if (typeof cocoSsd === 'undefined') {
    console.error('cocoSsd global not found ‚Äî CDN script may not have loaded');
    q('align-txt').textContent = 'Alinear manualmente';
    q('align-sub').textContent = 'Biblioteca de IA no disponible';
    startMotionOnlyDetection();
    return;
  }

  cocoSsd.load({ base: 'lite_mobilenet_v2' }).then(function(model) {
    A.model = model;
    A.modelReady = true;
    A._firstDetection = true; // flag to toast on first detection
    q('align-txt').textContent = 'Apunta al veh√≠culo';
    q('align-sub').textContent = 'IA lista ‚Äî ¬°busca el auto!';
    toast('üß† IA cargada');
    startVehicleDetection();
  }).catch(function(err) {
    console.error('COCO-SSD load failed:', err);
    A.modelReady = false;
    q('align-txt').textContent = 'Alinear manualmente';
    q('align-sub').textContent = 'IA no disponible ‚Äî ' + (err.message || 'error de carga');
    // Fall back to motion-only detection
    startMotionOnlyDetection();
  });
}

function resetAlign() {
  A.state = 'seeking';
  A.steadyStart = 0;
  A.autoCapturing = false;
  A.lastStateChange = 0;
  A.positionHistory = [];
  S.autoCapturing = false;
  setAlignState('seeking');
  if (A.modelReady) {
    q('align-txt').textContent = 'Apunta al veh√≠culo';
  } else {
    q('align-txt').textContent = 'Alinea la c√°mara';
  }
  q('align-arrows').innerHTML = '';
  q('hold-progress').classList.remove('visible');
  setProgress(0);
}

function setAlignState(state) {
  A.state = state;
  var frame = q('align-frame');
  var badge = q('align-txt');
  frame.className = state;
  badge.className = 'align-badge ' + state;
}

function setProgress(pct) {
  var circumference = 251.3;
  var offset = circumference * (1 - pct);
  q('prog-circle').style.strokeDashoffset = offset;
}

// Get the overlay/alignment frame's position relative to the video feed
function getOverlayRect() {
  var frame = q('align-frame');
  var video = q('video');
  var vRect = video.getBoundingClientRect();
  var fRect = frame.getBoundingClientRect();

  // Normalize to 0-1 relative to video display area
  return {
    x: (fRect.left - vRect.left) / vRect.width,
    y: (fRect.top - vRect.top) / vRect.height,
    w: fRect.width / vRect.width,
    h: fRect.height / vRect.height,
    cx: ((fRect.left + fRect.width/2) - vRect.left) / vRect.width,
    cy: ((fRect.top + fRect.height/2) - vRect.top) / vRect.height
  };
}

// Calculate how well the detected vehicle matches the overlay position
// Returns { score: 0-1, hints: ['left','up',...] }
function calcPositionMatch(detection, overlayRect) {
  var v = q('video');
  var vw = v.videoWidth;
  var vh = v.videoHeight;
  var vRect = v.getBoundingClientRect();

  // COCO-SSD detect() on a video element returns bbox in the video's natural
  // coordinate space (videoWidth x videoHeight). We need to map these to the
  // same normalised 0-1 space used by overlayRect, which is relative to the
  // displayed CSS rect of the video element.
  //
  // Because the video uses object-fit:cover, there may be cropping. We need
  // to compute the actual visible portion of the video inside the CSS rect.
  var elemW = vRect.width;
  var elemH = vRect.height;
  var elemAR = elemW / elemH;
  var vidAR = vw / vh;

  // object-fit:cover scaling
  var scale, offX = 0, offY = 0;
  if (vidAR > elemAR) {
    // video is wider than element ‚Äî cropped on left/right
    scale = elemH / vh;
    offX = (vw * scale - elemW) / 2;
  } else {
    // video is taller ‚Äî cropped on top/bottom
    scale = elemW / vw;
    offY = (vh * scale - elemH) / 2;
  }

  // Map detection bbox from video-pixel space to CSS-pixel space, then normalise
  var det = {
    x: (detection.bbox[0] * scale - offX) / elemW,
    y: (detection.bbox[1] * scale - offY) / elemH,
    w: (detection.bbox[2] * scale) / elemW,
    h: (detection.bbox[3] * scale) / elemH
  };
  det.cx = det.x + det.w/2;
  det.cy = det.y + det.h/2;

  var ov = overlayRect;
  var hints = [];

  // Center offset (how far off center)
  var dx = det.cx - ov.cx;
  var dy = det.cy - ov.cy;

  // Size ratio (detected vs overlay)
  var sizeRatio = (det.w * det.h) / (ov.w * ov.h);

  // Directional hints
  if (dx < -0.08) hints.push('right');  // car is to the left, move phone right
  if (dx > 0.08) hints.push('left');    // car is to the right, move phone left
  if (dy < -0.08) hints.push('down');   // car is above, move phone down
  if (dy > 0.08) hints.push('up');      // car is below, move phone up
  if (sizeRatio < 0.35) hints.push('closer');
  if (sizeRatio > 2.0) hints.push('back');

  // Score: combine center accuracy and size accuracy
  var centerScore = 1 - Math.min(Math.sqrt(dx*dx + dy*dy) / 0.3, 1);
  var sizeScore = 1 - Math.min(Math.abs(Math.log(Math.max(sizeRatio, 0.1))) / 1.5, 1);

  // Overlap score (IoU-like)
  var ix1 = Math.max(det.x, ov.x);
  var iy1 = Math.max(det.y, ov.y);
  var ix2 = Math.min(det.x + det.w, ov.x + ov.w);
  var iy2 = Math.min(det.y + det.h, ov.y + ov.h);
  var interArea = Math.max(0, ix2-ix1) * Math.max(0, iy2-iy1);
  var unionArea = det.w*det.h + ov.w*ov.h - interArea;
  var iou = unionArea > 0 ? interArea/unionArea : 0;

  var score = centerScore * 0.35 + sizeScore * 0.25 + iou * 0.40;

  return { score: score, hints: hints, sizeRatio: sizeRatio };
}

// Build directional arrows HTML
function buildArrowsHTML(hints) {
  if (!hints || hints.length === 0) return '';
  var arrows = {
    left: '<span class="dir-arrow left">‚óÄ</span>',
    right: '<span class="dir-arrow right">‚ñ∂</span>',
    up: '<span class="dir-arrow up">‚ñ≤</span>',
    down: '<span class="dir-arrow down">‚ñº</span>',
    closer: '<span class="dir-arrow down" style="font-size:14px;">üîç+</span>',
    back: '<span class="dir-arrow up" style="font-size:14px;">üîç‚àí</span>'
  };
  var html = '';
  for (var i = 0; i < hints.length; i++) {
    if (arrows[hints[i]]) html += arrows[hints[i]];
  }
  return html;
}

// Build hint text from directional hints
function buildHintText(hints) {
  if (!hints || hints.length === 0) return 'Alinea la c√°mara';
  var texts = [];
  for (var i = 0; i < hints.length; i++) {
    if (hints[i] === 'left') texts.push('Mover izquierda');
    if (hints[i] === 'right') texts.push('Mover derecha');
    if (hints[i] === 'up') texts.push('Mover arriba');
    if (hints[i] === 'down') texts.push('Mover abajo');
    if (hints[i] === 'closer') texts.push('Ac√©rcate');
    if (hints[i] === 'back') texts.push('Al√©jate');
  }
  return texts.slice(0, 2).join(' ¬∑ ');
}

// Run vehicle detection on current video frame
function detectVehicle() {
  if (!A.modelReady || !A.model || A.detecting) return;
  if (A.state === 'captured' || S.autoCapturing) return;

  var v = q('video');
  if (!v || v.readyState < 2) return;

  A.detecting = true;

  // Determine which classes to look for
  var isInterior = (S.cat === 'interior');
  var validClasses = isInterior ? A.interiorClasses : A.vehicleClasses;
  var minScore = isInterior ? 0.25 : 0.30;

  A.model.detect(v, 8, minScore).then(function(predictions) {
    A.detecting = false;
    if (A.state === 'captured' || S.autoCapturing) return;

    // Find best vehicle detection
    var best = null;
    var bestScore = 0;
    for (var i = 0; i < predictions.length; i++) {
      var p = predictions[i];
      if (validClasses.indexOf(p.class) !== -1 && p.score > minScore && p.score > bestScore) {
        best = p;
        bestScore = p.score;
      }
    }

    var now = Date.now();
    var sinceLastChange = now - A.lastStateChange;

    if (!best) {
      // No vehicle found
      A.positionHistory = [];
      if (A.state !== 'seeking') {
        if (sinceLastChange < A.debounceMs) return;
        A.lastStateChange = now;
        setAlignState('seeking');
        q('align-txt').textContent = isInterior ? 'Apunta al interior' : 'Busca el veh√≠culo';
        q('align-sub').textContent = 'No se detect√≥ ' + (isInterior ? 'objeto' : 'veh√≠culo');
        q('align-arrows').innerHTML = '';
        q('hold-progress').classList.remove('visible');
        A.steadyStart = 0;
        setProgress(0);
      }
      return;
    }

    // We found a vehicle ‚Äî check position
    var overlayRect = getOverlayRect();
    var match = calcPositionMatch(best, overlayRect);

    // Notify user on first successful detection
    if (A._firstDetection) {
      A._firstDetection = false;
      toast('üöó ' + best.class + ' detectado (' + Math.round(best.score*100) + '%)');
    }

    // Smooth the score
    A.positionHistory.push(match.score);
    if (A.positionHistory.length > A.posHistorySize) A.positionHistory.shift();
    var avgScore = 0;
    for (var i = 0; i < A.positionHistory.length; i++) avgScore += A.positionHistory[i];
    avgScore /= A.positionHistory.length;

    if (avgScore >= A.thresholdLock && A.positionHistory.length >= 3) {
      // Well positioned ‚Äî locked (green)!
      if (A.state !== 'locked') {
        if (sinceLastChange < A.debounceMs) return;
        A.lastStateChange = now;
        setAlignState('locked');
        q('align-txt').textContent = '‚óè No te muevas...';
        q('align-arrows').innerHTML = '‚úì';
        q('hold-progress').classList.add('visible');
        A.steadyStart = now;
        if (navigator.vibrate) navigator.vibrate(15);
      }
      // Progress toward auto-capture
      var elapsed = now - A.steadyStart;
      var pct = Math.min(elapsed / A.holdTime, 1);
      setProgress(pct);

      if (pct >= 1 && !S.autoCapturing) {
        S.autoCapturing = true;
        if (navigator.vibrate) navigator.vibrate([40, 30, 40]);
        capture();
      }
    } else if (avgScore >= A.thresholdClose) {
      // Getting close ‚Äî yellow
      if (A.state !== 'close') {
        if (sinceLastChange < A.debounceMs) return;
        A.lastStateChange = now;
        setAlignState('close');
        q('hold-progress').classList.remove('visible');
        A.steadyStart = 0;
        setProgress(0);
      }
      q('align-txt').textContent = '¬°Casi listo!';
      q('align-arrows').innerHTML = buildArrowsHTML(match.hints);
      q('align-sub').textContent = buildHintText(match.hints) || 'Ajusta la posici√≥n';
    } else {
      // Vehicle found but not aligned ‚Äî red with directional guidance
      if (A.state !== 'seeking') {
        if (sinceLastChange < A.debounceMs) return;
        A.lastStateChange = now;
      }
      setAlignState('seeking');
      q('align-txt').textContent = buildHintText(match.hints) || 'Ajusta la posici√≥n';
      q('align-arrows').innerHTML = buildArrowsHTML(match.hints);
      q('align-sub').textContent = (best.class === 'car' ? 'Auto' : best.class) + ' detectado ‚Äî ajusta el encuadre';
      q('hold-progress').classList.remove('visible');
      A.steadyStart = 0;
      setProgress(0);
    }
  }).catch(function(err) {
    A.detecting = false;
    console.error('Detection error:', err);
  });
}

// Start vehicle detection loop
function startVehicleDetection() {
  if (A.detectionInterval) clearInterval(A.detectionInterval);
  // Run detection every 350ms (fast enough for guidance, light enough for phone)
  A.detectionInterval = setInterval(detectVehicle, 350);
}

// Fallback: motion-only detection (if AI model fails to load)
function startMotionOnlyDetection() {
  if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
    DeviceMotionEvent.requestPermission().then(function(response) {
      if (response === 'granted') {
        window.addEventListener('devicemotion', onDeviceMotionFallbackOnly, true);
      }
    }).catch(function() {
      startFrameFallback();
    });
  } else if (typeof DeviceMotionEvent !== 'undefined') {
    window.addEventListener('devicemotion', onDeviceMotionFallbackOnly, true);
    setTimeout(function() {
      if (!A._gotMotionEvent) startFrameFallback();
    }, 1000);
  } else {
    startFrameFallback();
  }
}

// Simple motion-only fallback (no AI) ‚Äî just steadiness
var motionFallbackSamples = [];
function onDeviceMotionFallbackOnly(e) {
  A._gotMotionEvent = true;
  var acc = e.accelerationIncludingGravity || e.acceleration;
  if (!acc) return;
  var mag = Math.sqrt(acc.x*acc.x + acc.y*acc.y + acc.z*acc.z);
  motionFallbackSamples.push(mag);
  if (motionFallbackSamples.length > 20) motionFallbackSamples.shift();
  if (motionFallbackSamples.length < 10) return;

  var sum = 0;
  for (var i = 0; i < motionFallbackSamples.length; i++) sum += motionFallbackSamples[i];
  var avg = sum / motionFallbackSamples.length;
  var variance = 0;
  for (var i = 0; i < motionFallbackSamples.length; i++) {
    var d = motionFallbackSamples[i] - avg;
    variance += d*d;
  }
  var jitter = Math.sqrt(variance / motionFallbackSamples.length);

  if (A.state === 'captured' || S.autoCapturing) return;
  var now = Date.now();
  var sinceLastChange = now - A.lastStateChange;

  if (jitter < 3.0) {
    if (A.state !== 'locked') {
      if (sinceLastChange < 400) return;
      A.lastStateChange = now;
      setAlignState('locked');
      q('align-txt').textContent = '‚óè No te muevas...';
      q('hold-progress').classList.add('visible');
      A.steadyStart = now;
    }
    var elapsed = now - A.steadyStart;
    var pct = Math.min(elapsed / A.holdTime, 1);
    setProgress(pct);
    if (pct >= 1 && !S.autoCapturing) {
      S.autoCapturing = true;
      if (navigator.vibrate) navigator.vibrate([40, 30, 40]);
      capture();
    }
  } else if (jitter < 6.0) {
    if (A.state !== 'close') {
      if (sinceLastChange < 400) return;
      A.lastStateChange = now;
      setAlignState('close');
      q('align-txt').textContent = '¬°Casi listo!';
      q('hold-progress').classList.remove('visible');
      A.steadyStart = 0; setProgress(0);
    }
  } else {
    if (A.state !== 'seeking') {
      if (sinceLastChange < 400) return;
      A.lastStateChange = now;
      setAlignState('seeking');
      q('align-txt').textContent = 'Mant√©n firme';
      q('hold-progress').classList.remove('visible');
      A.steadyStart = 0; setProgress(0);
    }
  }
}

// Frame-based fallback for desktop (no motion, no AI)
function startFrameFallback() {
  var miniCanvas = document.createElement('canvas');
  miniCanvas.width = 64; miniCanvas.height = 48;
  var ctx = miniCanvas.getContext('2d');
  var prevFrame = null;

  function checkFrame() {
    if (A.state === 'captured' || S.autoCapturing) { prevFrame = null; A.rafId = requestAnimationFrame(checkFrame); return; }
    var v = q('video');
    if (!v || v.readyState < 2) { A.rafId = requestAnimationFrame(checkFrame); return; }
    ctx.drawImage(v, 0, 0, 64, 48);
    var data = ctx.getImageData(0, 0, 64, 48).data;
    if (prevFrame) {
      var diff = 0, pixels = data.length / 4;
      for (var i = 0; i < data.length; i += 16) {
        diff += Math.abs(data[i] - prevFrame[i]) + Math.abs(data[i+1] - prevFrame[i+1]) + Math.abs(data[i+2] - prevFrame[i+2]);
      }
      var avgDiff = diff / (pixels / 4);
      var jitter = avgDiff / 10;
      // Reuse the simple motion fallback logic
      var now = Date.now();
      var sinceLastChange = now - A.lastStateChange;
      if (A.state !== 'captured' && !S.autoCapturing) {
        if (jitter < 1.2) {
          if (A.state !== 'locked') { if (sinceLastChange < 400) { prevFrame = new Uint8Array(data); A.rafId = requestAnimationFrame(checkFrame); return; } A.lastStateChange = now; setAlignState('locked'); q('align-txt').textContent = '‚óè No te muevas...'; q('hold-progress').classList.add('visible'); A.steadyStart = now; }
          var elapsed = now - A.steadyStart; var pct = Math.min(elapsed / A.holdTime, 1); setProgress(pct);
          if (pct >= 1 && !S.autoCapturing) { S.autoCapturing = true; capture(); }
        } else if (jitter < 3.0) {
          if (A.state !== 'close') { if (sinceLastChange < 400) { prevFrame = new Uint8Array(data); A.rafId = requestAnimationFrame(checkFrame); return; } A.lastStateChange = now; setAlignState('close'); q('align-txt').textContent = '¬°Casi listo!'; q('hold-progress').classList.remove('visible'); A.steadyStart = 0; setProgress(0); }
        } else {
          if (A.state !== 'seeking') { if (sinceLastChange < 400) { prevFrame = new Uint8Array(data); A.rafId = requestAnimationFrame(checkFrame); return; } A.lastStateChange = now; setAlignState('seeking'); q('align-txt').textContent = 'Mant√©n firme'; q('hold-progress').classList.remove('visible'); A.steadyStart = 0; setProgress(0); }
        }
      }
    }
    prevFrame = new Uint8Array(data);
    A.rafId = requestAnimationFrame(checkFrame);
  }
  A.rafId = requestAnimationFrame(checkFrame);
}

// Start the detection system (called when camera starts)
function startMotionDetection() {
  // Try to load AI model; falls back to motion-only if it fails
  loadDetectionModel();
}

// Gallery
function updGal() {
  var n = S.photos.length;
  if (n > 0) {
    q('gp').style.backgroundImage = 'url(' + S.photos[n-1].url + ')';
    q('gb').style.display = 'flex';
    q('gb').textContent = n;
  } else {
    q('gp').style.backgroundImage = '';
    q('gb').style.display = 'none';
  }
}

function showGal() {
  q('gallery').classList.add('visible');
  if (S.photos.length === 0) {
    q('g-grid').innerHTML = '<div class="ge">Sin fotos a√∫n</div>';
  } else {
    var html = '';
    for (var i = 0; i < S.photos.length; i++) {
      html += '<div class="gi" onclick="dlP(' + i + ')">';
      html += '<img src="' + S.photos[i].url + '">';
      html += '<div class="tag">' + S.photos[i].label + '</div>';
      html += '</div>';
    }
    q('g-grid').innerHTML = html;
  }
}

function dlP(i) {
  var p = S.photos[i];
  var a = document.createElement('a');
  a.href = p.url;
  a.download = p.label.replace(/\s+/g, '_') + '_' + Date.now() + '.jpg';
  a.click();
  toast('Guardada');
}

function toast(m) {
  q('toast').textContent = m;
  q('toast').classList.add('show');
  setTimeout(function() { q('toast').classList.remove('show'); }, 2000);
}

function toggleFS() {
  if (!document.fullscreenElement && !document.webkitFullscreenElement) {
    var el = document.documentElement;
    if (el.requestFullscreen) {
      el.requestFullscreen({ navigationUI: 'hide' }).then(function() {
        setTimeout(fixViewport, 100);
        toast('Pantalla completa');
      }).catch(function(){
        // iOS fallback: try video fullscreen
        var v = q('video');
        if (v && v.webkitEnterFullscreen) {
          try { v.webkitEnterFullscreen(); } catch(e2) {}
        }
      });
    } else if (el.webkitRequestFullscreen) {
      el.webkitRequestFullscreen();
    } else {
      // Last resort for iOS: try video element
      var v = q('video');
      if (v && v.webkitEnterFullscreen) {
        try { v.webkitEnterFullscreen(); } catch(e) {}
      }
    }
  } else {
    if (document.exitFullscreen) document.exitFullscreen();
    else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
  }
}

// Events
q('start-btn').onclick = startCam;
q('close-btn').onclick = function() {
  if (S.stream) S.stream.getTracks().forEach(function(t){t.stop();});
  q('cam').classList.add('hidden');
  q('perm').classList.remove('hidden');
};
q('fs-btn').onclick = toggleFS;
q('sw-btn').onclick = flipCam;
q('sw2').onclick = flipCam;
q('cap').onclick = capture;
q('gp').onclick = showGal;
q('g-back').onclick = function() { q('gallery').classList.remove('visible'); };
q('g-clear').onclick = function() {
  if (confirm('¬øBorrar todas las fotos?')) { S.photos = []; updGal(); showGal(); toast('Borradas'); }
};

q('tabs').onclick = function(e) {
  var t = e.target;
  while (t && !t.classList.contains('cat-tab')) t = t.parentElement;
  if (t && t.dataset.cat) loadCat(t.dataset.cat);
};

q('shots').onclick = function(e) {
  var t = e.target;
  while (t && !t.classList.contains('shot-thumb')) t = t.parentElement;
  if (t && t.dataset.i !== undefined) pickShot(parseInt(t.dataset.i));
};

document.onkeydown = function(e) {
  if (e.code === 'Space') { e.preventDefault(); capture(); }
  if (e.code === 'ArrowRight') pickShot(S.idx + 1);
  if (e.code === 'ArrowLeft') pickShot(S.idx - 1);
  if (e.code === 'KeyF') flipCam();
};

// ===== PHONE VIEWPORT FIX =====
// Use visualViewport to perfectly size the app to whatever Safari gives us
// This works WITH the toolbar ‚Äî no fighting Safari
function fixViewport() {
  var vh, vw;
  if (window.visualViewport) {
    vh = window.visualViewport.height;
    vw = window.visualViewport.width;
  } else {
    vh = window.innerHeight;
    vw = window.innerWidth;
  }
  // Set CSS custom property so all elements use the real visible height
  document.documentElement.style.setProperty('--app-h', vh + 'px');
  // Also pin the offset in case Safari scrolls the viewport
  if (window.visualViewport && window.visualViewport.offsetTop > 0) {
    window.scrollTo(0, 0);
  }
}

// Listen to visualViewport changes (Safari iOS toolbar show/hide triggers this)
if (window.visualViewport) {
  window.visualViewport.addEventListener('resize', fixViewport);
  window.visualViewport.addEventListener('scroll', fixViewport);
}
window.addEventListener('resize', fixViewport);
window.addEventListener('orientationchange', function() {
  setTimeout(fixViewport, 50);
  setTimeout(fixViewport, 200);
  setTimeout(fixViewport, 500);
});

// Prevent any accidental scrolling that would show black gaps
document.addEventListener('touchmove', function(e) {
  // Allow scrolling inside shot carousel and gallery grid
  var t = e.target;
  while (t) {
    if (t.classList && (t.classList.contains('shot-carousel') || t.classList.contains('gg'))) return;
    t = t.parentElement;
  }
  e.preventDefault();
}, { passive: false });

// Initial
fixViewport();

// ===== FULLSCREEN ON CAMERA START =====
var origStartCam = startCam;
startCam = function() {
  // Try fullscreen (Chrome Android = works, iOS = won't but we try anyway)
  try {
    var el = document.documentElement;
    if (el.requestFullscreen) {
      el.requestFullscreen({ navigationUI: 'hide' }).then(function() {
        setTimeout(fixViewport, 100);
        setTimeout(fixViewport, 400);
      }).catch(function(){
        // iOS: requestFullscreen fails, just fix viewport
        fixViewport();
      });
    } else if (el.webkitRequestFullscreen) {
      el.webkitRequestFullscreen();
    }
  } catch(e) {}

  // Keep screen awake while camera is active
  try {
    if ('wakeLock' in navigator) {
      navigator.wakeLock.request('screen').catch(function(){});
    }
  } catch(e) {}

  fixViewport();
  origStartCam();
  setTimeout(fixViewport, 300);
  setTimeout(fixViewport, 800);
};

// Re-fix viewport when entering/exiting fullscreen
document.addEventListener('fullscreenchange', function() {
  setTimeout(fixViewport, 50);
  setTimeout(fixViewport, 200);
  setTimeout(fixViewport, 500);
});
document.addEventListener('webkitfullscreenchange', function() {
  setTimeout(fixViewport, 50);
  setTimeout(fixViewport, 200);
});

// ===== PWA INSTALL BANNER =====
(function() {
  var ua = navigator.userAgent;
  var isIOS = /iPad|iPhone|iPod/.test(ua);
  var isChromeIOS = /CriOS/.test(ua);
  var isSafariIOS = isIOS && /Safari/.test(ua) && !isChromeIOS && !/FxiOS|EdgiOS/.test(ua);
  var isAndroid = /Android/.test(ua);
  var isStandalone = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches || window.matchMedia('(display-mode: fullscreen)').matches;
  var dismissed = localStorage.getItem('pwa-dismissed');
  var savedPrompt = null;

  function showBanner(title, msg) {
    if (dismissed || isStandalone) return;
    q('pwa-title').textContent = title;
    q('pwa-msg').textContent = msg;
    setTimeout(function() {
      q('pwa-banner').style.display = 'block';
    }, 2500);
  }

  // iOS Safari: "Add to Home Screen" from share menu
  if (isSafariIOS && !isStandalone && !dismissed) {
    showBanner('Pantalla Completa', 'Toca Compartir ‚Üó y luego "A√±adir a pantalla de inicio" para quitar las barras del navegador.');
  }

  // Chrome on iPhone: can't do fullscreen, suggest opening in Safari to add to home screen
  if (isChromeIOS && !isStandalone && !dismissed) {
    showBanner('Para mejor experiencia', 'Abre en Safari ‚Üí Compartir ‚Üó ‚Üí "A√±adir a pantalla de inicio" para modo pantalla completa. O toca ‚õ∂ para probar.');
  }

  // Chrome Android: native install prompt
  window.addEventListener('beforeinstallprompt', function(e) {
    e.preventDefault();
    savedPrompt = e;
    if (!dismissed && !isStandalone) {
      showBanner('Instalar App', 'Instala para pantalla completa sin barras del navegador.');
    }
  });

  q('pwa-dismiss').onclick = function() {
    q('pwa-banner').style.display = 'none';
    localStorage.setItem('pwa-dismissed', '1');
    // If we have a Chrome install prompt, trigger it
    if (savedPrompt) {
      savedPrompt.prompt();
      savedPrompt = null;
    }
  };
})();

// ===== LOCK LANDSCAPE HINT =====
screen.orientation && screen.orientation.lock && screen.orientation.lock('landscape').catch(function(){});

// ===== SERVICE WORKER (required for Chrome PWA install) =====
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(function(){});
}

// ===== PERMISSION SCREEN TIP =====
(function() {
  var ua = navigator.userAgent;
  var tip = q('perm-tip');
  var isIOS = /iPad|iPhone|iPod/.test(ua);
  var isChromeIOS = /CriOS/.test(ua);
  var isStandalone = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches || window.matchMedia('(display-mode: fullscreen)').matches;

  if (isStandalone) {
    tip.textContent = '‚úì Ejecut√°ndose en pantalla completa';
    tip.style.color = 'rgba(100,255,100,0.5)';
  } else if (isChromeIOS) {
    tip.textContent = 'Consejo: Abre en Safari ‚Üí A√±adir a pantalla de inicio para pantalla completa';
  } else if (isIOS) {
    tip.textContent = 'Consejo: A√±adir a pantalla de inicio para pantalla completa (sin barras)';
  } else {
    tip.textContent = 'Se abre en pantalla completa';
  }
})();
</script>
</body>
</html>
