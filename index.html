<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover, maximum-scale=1, interactive-widget=resizes-content">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#000000">
  <title>Ghost Overlay Camera</title>
  <link rel="manifest" href="manifest.json">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html, body {
      width:100%; height:100%; overflow:hidden;
      background:#000;
      font-family:-apple-system,BlinkMacSystemFont,'SF Pro','Helvetica Neue',sans-serif;
      color:#fff; touch-action:manipulation;
      /* CSS custom prop set by JS from visualViewport */
      --app-h: 100vh;
    }

    /* ===== PERMISSION ===== */
    #perm { position:fixed; top:0; left:0; width:100%; height:var(--app-h, 100vh); display:flex; flex-direction:column; align-items:center; justify-content:center; background:#000; z-index:100; padding:40px; text-align:center; }
    #perm.hidden { display:none; }
    .perm-icon { font-size:48px; margin-bottom:20px; }
    .perm-title { font-size:26px; font-weight:700; margin-bottom:10px; }
    .perm-sub { font-size:15px; color:rgba(255,255,255,0.5); margin-bottom:36px; max-width:280px; line-height:1.5; }
    .perm-btn { background:#fff; color:#000; border:none; padding:16px 56px; border-radius:14px; font-size:17px; font-weight:600; cursor:pointer; }
    .perm-btn:active { transform:scale(0.96); }
    #perm-err { color:#ff6b6b; margin-top:16px; font-size:13px; display:none; }

    /* ===== CAMERA ===== */
    #cam { position:fixed; top:0; left:0; width:100%; height:var(--app-h, 100vh); background:#000; overflow:hidden; }
    #cam.hidden { display:none; }
    #video { position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; }

    /* ===== GHOST OVERLAY â€” BIG ===== */
    #ghost { position:absolute; top:0; left:0; right:0; bottom:0; display:flex; align-items:center; justify-content:center; pointer-events:none; z-index:10; padding:0; }
    #ghost img {
      width: 100%;
      height: calc(var(--app-h, 100vh) * 0.65);
      object-fit: contain;
      opacity: 0.5;
      filter: drop-shadow(0 0 6px rgba(200,160,60,0.4));
      transition: opacity 0.3s, filter 0.3s;
      margin-top: -40px;
    }

    /* ===== LANDSCAPE MODE (PHONE) ===== */
    @media (orientation: landscape) {
      #ghost img {
        height: calc(var(--app-h, 100vh) * 0.75);
        width: 50%;
        margin-top: -20px;
      }
      .top-bar { padding-top:4px !important; padding-bottom:2px; }
      .top-close { font-size:20px; }
      .top-right { flex-direction:row; gap:6px; }
      .top-icon-btn { font-size:16px; padding:4px; }
      /* Keep bottom panel at bottom, just shrink everything */
      .bottom-panel { padding-bottom:max(env(safe-area-inset-bottom,4px),4px) !important; }
      .cat-tabs { padding:2px 8px 0; }
      .cat-tab { padding:3px 12px; font-size:11px; }
      .shot-carousel { padding:4px 10px; gap:6px; }
      .shot-thumb { width:32px; height:32px; padding:3px; }
      .shot-thumb.active { width:40px; height:40px; }
      .capture-row { padding:2px 16px 2px; gap:16px; }
      .cap-btn { width:46px; height:46px; border-width:3px; }
      .cap-btn::after { inset:3px; }
      .gallery-preview, .side-btn { width:30px; height:30px; font-size:14px; }
      .gallery-preview { border-radius:6px; }
      .gal-badge { width:14px; height:14px; font-size:8px; top:-3px; right:-3px; }
      .align-prompt { bottom:140px; }
      .align-badge { padding:6px 16px; font-size:12px; }
      .align-arrow { font-size:18px; }
      .align-sub { font-size:11px; }
    }

    /* Extra compact for very short phones in landscape */
    @media (orientation: landscape) and (max-height: 400px) {
      .top-bar { padding:2px 10px !important; }
      .top-close { font-size:18px; }
      #ghost img { height: calc(var(--app-h, 100vh) * 0.80); width: 45%; margin-top: -10px; }
      .shot-carousel { padding:2px 8px; gap:4px; }
      .shot-thumb { width:26px; height:26px; padding:2px; }
      .shot-thumb.active { width:34px; height:34px; }
      .capture-row { padding:1px 12px; gap:12px; }
      .cap-btn { width:38px; height:38px; }
      .cat-tabs { padding:1px 6px 0; }
      .cat-tab { font-size:10px; padding:2px 8px; }
      .gallery-preview, .side-btn { width:26px; height:26px; }
      .align-prompt { bottom:110px; }
    }

    /* ===== TOP BAR ===== */
    .top-bar {
      position:absolute; top:0; left:0; right:0;
      padding: env(safe-area-inset-top, 8px) 16px 10px;
      background:linear-gradient(to bottom, rgba(0,0,0,0.75) 0%, transparent 100%);
      z-index:20; display:flex; align-items:flex-start; justify-content:space-between;
    }
    .top-close { background:none; border:none; color:#fff; font-size:28px; cursor:pointer; padding:6px; line-height:1; }
    .top-right { display:flex; flex-direction:column; gap:14px; align-items:center; }
    .top-icon-btn { background:none; border:none; color:#fff; font-size:22px; cursor:pointer; padding:6px; opacity:0.7; }

    /* ===== ALIGNMENT PROMPT ===== */
    .align-prompt {
      position:absolute; left:0; right:0; z-index:15;
      bottom: 290px;
      display:flex; flex-direction:column; align-items:center; gap:6px;
      pointer-events:none;
    }
    .align-arrow { font-size:28px; opacity:0.5; animation:bounce 1.5s ease infinite; }
    @keyframes bounce { 0%,100%{transform:translateY(0);} 50%{transform:translateY(6px);} }
    .align-badge {
      background:rgba(160,130,80,0.85);
      backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px);
      padding:12px 28px; border-radius:14px; font-size:16px; font-weight:600;
    }
    .align-sub { font-size:13px; color:rgba(255,255,255,0.5); }

    /* ===== BOTTOM PANEL ===== */
    .bottom-panel {
      position:absolute; bottom:0; left:0; right:0; z-index:20;
      background:linear-gradient(to top, rgba(0,0,0,0.95) 55%, rgba(0,0,0,0.6) 85%, transparent 100%);
      padding:0 0 max(env(safe-area-inset-bottom,10px),10px);
    }

    /* Shot carousel */
    .shot-carousel {
      display:flex; gap:10px; justify-content:center; align-items:center;
      padding:14px 16px 14px; overflow-x:auto;
      scrollbar-width:none; -webkit-overflow-scrolling:touch;
    }
    .shot-carousel::-webkit-scrollbar { display:none; }

    .shot-thumb {
      flex-shrink:0; width:52px; height:52px; border-radius:50%;
      background:#1c1c1e; border:2px solid rgba(255,255,255,0.12);
      overflow:hidden; cursor:pointer; transition:all 0.2s ease;
      display:flex; align-items:center; justify-content:center; padding:5px;
    }
    .shot-thumb img { width:100%; height:100%; object-fit:contain; filter:brightness(0.65) saturate(0.6); transition:filter 0.2s; }
    .shot-thumb.active {
      width:66px; height:66px; border:3px solid #fff;
      box-shadow:0 0 0 3px rgba(255,255,255,0.12);
    }
    .shot-thumb.active img { filter:brightness(1) saturate(1); }

    /* Capture row */
    .capture-row { display:flex; align-items:center; justify-content:center; gap:32px; padding:4px 20px 8px; }

    .cap-btn {
      width:70px; height:70px; border-radius:50%;
      border:4px solid rgba(255,255,255,0.85); background:transparent;
      cursor:pointer; position:relative; transition:transform 0.1s;
    }
    .cap-btn::after { content:''; position:absolute; inset:4px; border-radius:50%; background:rgba(255,255,255,0.85); transition:opacity 0.1s; }
    .cap-btn:active { transform:scale(0.92); }
    .cap-btn.flash::after { opacity:0.3; }

    .side-btn {
      width:42px; height:42px; border-radius:50%; border:none;
      background:rgba(255,255,255,0.1); color:#fff; font-size:18px;
      cursor:pointer; display:flex; align-items:center; justify-content:center;
    }
    .gallery-preview {
      width:42px; height:42px; border-radius:10px;
      border:2px solid rgba(255,255,255,0.2); background:#111;
      background-size:cover; background-position:center;
      cursor:pointer; position:relative;
    }
    .gal-badge {
      position:absolute; top:-5px; right:-5px;
      background:#007AFF; color:#fff; font-size:10px; font-weight:700;
      width:18px; height:18px; border-radius:50%;
      display:none; align-items:center; justify-content:center;
    }

    /* Category tabs */
    .cat-tabs {
      display:flex; justify-content:center; align-items:center;
      padding:8px 12px 2px; gap:0;
    }
    .cat-tab {
      padding:7px 18px; border:none; background:none;
      color:rgba(255,255,255,0.35); font-size:14px; font-weight:500;
      cursor:pointer; white-space:nowrap; position:relative; transition:color 0.2s;
    }
    .cat-tab.active { color:#e74c3c; font-weight:600; }
    .cat-tab.active::after {
      content:''; position:absolute; bottom:0; left:25%; right:25%;
      height:2px; background:#e74c3c; border-radius:1px;
    }

    /* ===== FLASH ===== */
    .flash-screen { position:fixed; top:0; left:0; width:100%; height:var(--app-h, 100vh); background:#fff; opacity:0; z-index:50; pointer-events:none; transition:opacity 0.08s; }
    .flash-screen.on { opacity:0.7; }

    /* ===== GALLERY ===== */
    #gallery { position:fixed; top:0; left:0; width:100%; height:var(--app-h, 100vh); background:#000; z-index:60; display:none; flex-direction:column; }
    #gallery.visible { display:flex; }
    .gh { display:flex; align-items:center; justify-content:space-between; padding:max(env(safe-area-inset-top,16px),44px) 16px 12px; background:rgba(0,0,0,0.95); }
    .gh button { background:none; border:none; font-size:16px; cursor:pointer; padding:8px; }
    .gh .back { color:#007AFF; }
    .gh .title { font-size:17px; font-weight:600; color:#fff; }
    .gh .clear { color:#ff6b6b; }
    .gg { flex:1; overflow-y:auto; padding:8px; display:grid; grid-template-columns:repeat(2,1fr); gap:8px; align-content:start; }
    .gi { aspect-ratio:3/4; border-radius:12px; overflow:hidden; position:relative; background:#111; cursor:pointer; }
    .gi img { width:100%; height:100%; object-fit:cover; }
    .gi .tag { position:absolute; bottom:8px; left:8px; background:rgba(0,0,0,0.7); padding:4px 10px; border-radius:6px; font-size:11px; }
    .ge { grid-column:1/-1; text-align:center; padding:60px; color:rgba(255,255,255,0.3); font-size:15px; }

    /* ===== TOAST ===== */
    .toast {
      position:fixed; top:max(env(safe-area-inset-top,16px),50px); left:50%;
      transform:translateX(-50%) translateY(-100px);
      background:rgba(0,0,0,0.85); backdrop-filter:blur(10px);
      padding:12px 24px; border-radius:12px; font-size:14px; font-weight:500;
      z-index:90; pointer-events:none; transition:transform 0.3s ease;
      border:1px solid rgba(255,255,255,0.1);
    }
    .toast.show { transform:translateX(-50%) translateY(0); }
  </style>
</head>
<body>

<!-- PERMISSION SCREEN -->
<div id="perm">
  <div class="perm-icon">ðŸ“·</div>
  <div class="perm-title">Ghost Overlay Camera</div>
  <div class="perm-sub">Guided vehicle photography with transparent wireframe overlays.</div>
  <button class="perm-btn" id="start-btn">ðŸ“· Start Camera</button>
  <div id="perm-tip" style="margin-top:12px; font-size:12px; color:rgba(255,255,255,0.3);"></div>
  <div id="perm-err"></div>
</div>

<!-- CAMERA SCREEN -->
<div id="cam" class="hidden">
  <video id="video" autoplay playsinline muted></video>

  <div id="ghost">
    <img id="overlay-img" src="" alt="">
  </div>

  <div class="top-bar">
    <button class="top-close" id="close-btn">&#x2715;</button>
    <div class="top-right">
      <button class="top-icon-btn" id="fs-btn" title="Fullscreen">&#x26F6;</button>
      <button class="top-icon-btn" id="sw-btn" title="Switch">&#x1F504;</button>
    </div>
  </div>

  <div class="align-prompt">
    <div class="align-arrow">&#x2304;</div>
    <div class="align-badge" id="align-txt">Align the camera!</div>
    <div class="align-sub" id="align-sub">Position vehicle within overlay</div>
  </div>

  <div class="bottom-panel">
    <div class="shot-carousel" id="shots"></div>
    <div class="capture-row">
      <div class="gallery-preview" id="gp"><div class="gal-badge" id="gb">0</div></div>
      <button class="cap-btn" id="cap"></button>
      <button class="side-btn" id="sw2">&#x1F504;</button>
    </div>
    <div class="cat-tabs" id="tabs">
      <button class="cat-tab active" data-cat="sedan">Sedan</button>
      <button class="cat-tab" data-cat="suv">SUV</button>
      <button class="cat-tab" data-cat="truck">Truck</button>
      <button class="cat-tab" data-cat="interior">Interior</button>
    </div>
  </div>

  <div class="flash-screen" id="flash"></div>
</div>

<!-- GALLERY -->
<div id="gallery">
  <div class="gh">
    <button class="back" id="g-back">&larr; Back</button>
    <span class="title">Captured Photos</span>
    <button class="clear" id="g-clear">Clear</button>
  </div>
  <div class="gg" id="g-grid"><div class="ge">No photos yet</div></div>
</div>

<div class="toast" id="toast"></div>

<!-- PWA Install Banner -->
<div id="pwa-banner" style="display:none; position:fixed; bottom:0; left:0; right:0; z-index:200; background:rgba(30,30,30,0.97); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px); padding:14px 16px; padding-bottom:max(env(safe-area-inset-bottom,14px),18px); border-top:1px solid rgba(255,255,255,0.1);">
  <div style="display:flex; align-items:center; gap:12px; max-width:500px; margin:0 auto;">
    <div style="font-size:28px;">ðŸ“·</div>
    <div style="flex:1;">
      <div style="font-size:13px; font-weight:600;" id="pwa-title">Go Fullscreen</div>
      <div style="font-size:11px; color:rgba(255,255,255,0.5); margin-top:2px; line-height:1.4;" id="pwa-msg">Tap â›¶ button or add to Home Screen for no browser bars!</div>
    </div>
    <button id="pwa-dismiss" style="background:rgba(255,255,255,0.15); border:none; color:#fff; padding:7px 14px; border-radius:8px; font-size:12px; cursor:pointer; white-space:nowrap;">Got it</button>
  </div>
</div>

<canvas id="cv" style="display:none"></canvas>

<script>
var OV = {
  sedan: [
    { f:'overlays/sedan/IMG_1199.png', l:'Side Left' },
    { f:'overlays/sedan/IMG_1200.png', l:'Front' },
    { f:'overlays/sedan/IMG_1201.png', l:'Side Right' },
    { f:'overlays/sedan/IMG_1202.png', l:'Front Left 45' },
    { f:'overlays/sedan/IMG_1203.png', l:'Rear Side' },
    { f:'overlays/sedan/IMG_1204.png', l:'Rear' },
    { f:'overlays/sedan/IMG_1205.png', l:'Top' },
    { f:'overlays/sedan/IMG_1207-Photoroom.png', l:'Front Right 45' }
  ],
  suv: [
    { f:'overlays/suv/IMG_1212.png', l:'Side Left' },
    { f:'overlays/suv/IMG_1213.png', l:'Front' },
    { f:'overlays/suv/IMG_1214.png', l:'Side Right' },
    { f:'overlays/suv/IMG_1215.png', l:'Rear Side' },
    { f:'overlays/suv/IMG_1216.png', l:'Rear' },
    { f:'overlays/suv/IMG_1217.png', l:'Top' }
  ],
  truck: [
    { f:'overlays/truck/IMG_1218.png', l:'Side Left' },
    { f:'overlays/truck/IMG_1219.png', l:'Front' },
    { f:'overlays/truck/IMG_1220.png', l:'Side Right' },
    { f:'overlays/truck/IMG_1221.png', l:'Front Left 45' },
    { f:'overlays/truck/IMG_1222.png', l:'Rear Side' },
    { f:'overlays/truck/IMG_1223.png', l:'Rear' },
    { f:'overlays/truck/IMG_1224.png', l:'Top' },
    { f:'overlays/truck/IMG_1225.png', l:'Front Right 45' }
  ],
  interior: [
    { f:'overlays/interior/IMG_1226.png', l:'Dashboard' },
    { f:'overlays/interior/IMG_1227.png', l:'Steering' },
    { f:'overlays/interior/IMG_1228.png', l:'Center Console' },
    { f:'overlays/interior/IMG_1229.png', l:'Rear Seats' },
    { f:'overlays/interior/IMG_1230.png', l:'Cargo' },
    { f:'overlays/interior/IMG_1231.png', l:'Door Panel' },
    { f:'overlays/interior/IMG_1232.png', l:'Gauges' }
  ]
};

var S = { stream:null, face:'environment', cat:'sedan', idx:0, photos:[] };

function q(id) { return document.getElementById(id); }

// Camera
function startCam() {
  if (S.stream) { S.stream.getTracks().forEach(function(t){t.stop();}); S.stream = null; }

  // Use "exact" to force the correct camera (especially in PWA mode on Android)
  var constraints = {
    video: {
      facingMode: { exact: S.face },
      width: { ideal: 1920 },
      height: { ideal: 1080 }
    },
    audio: false
  };

  navigator.mediaDevices.getUserMedia(constraints)
  .then(onCamSuccess)
  .catch(function(e) {
    // "exact" failed â€” try without "exact" as fallback
    var fallback = {
      video: {
        facingMode: S.face,
        width: { ideal: 1920 },
        height: { ideal: 1080 }
      },
      audio: false
    };
    return navigator.mediaDevices.getUserMedia(fallback).then(onCamSuccess);
  })
  .catch(function(e) {
    // Last resort: just get any camera
    return navigator.mediaDevices.getUserMedia({ video: true, audio: false }).then(onCamSuccess);
  })
  .catch(function(e) {
    var err = q('perm-err');
    err.style.display = 'block';
    if (e.name === 'NotAllowedError') {
      err.textContent = 'Camera denied. Allow in settings and reload.';
    } else {
      err.textContent = 'Error: ' + e.message;
    }
  });
}

function onCamSuccess(stream) {
  S.stream = stream;
  q('video').srcObject = stream;
  q('video').play();
  q('perm').classList.add('hidden');
  q('cam').classList.remove('hidden');
  loadCat(S.cat);

  // Check which camera we actually got and update S.face
  var track = stream.getVideoTracks()[0];
  if (track) {
    var settings = track.getSettings();
    if (settings.facingMode) {
      S.face = settings.facingMode;
    }
  }
}

function flipCam() {
  S.face = (S.face === 'environment') ? 'user' : 'environment';
  startCam();
  toast(S.face === 'environment' ? 'Rear camera' : 'Front camera');
}

// Category
function loadCat(cat) {
  S.cat = cat;
  S.idx = 0;
  var tabBtns = document.querySelectorAll('.cat-tab');
  for (var i = 0; i < tabBtns.length; i++) {
    if (tabBtns[i].dataset.cat === cat) { tabBtns[i].classList.add('active'); }
    else { tabBtns[i].classList.remove('active'); }
  }
  var shots = OV[cat];
  var html = '';
  for (var i = 0; i < shots.length; i++) {
    html += '<div class="shot-thumb' + (i === 0 ? ' active' : '') + '" data-i="' + i + '">';
    html += '<img src="' + shots[i].f + '" alt="' + shots[i].l + '">';
    html += '</div>';
  }
  q('shots').innerHTML = html;
  pickShot(0);
}

function pickShot(i) {
  var shots = OV[S.cat];
  if (i < 0 || i >= shots.length) return;
  S.idx = i;
  q('overlay-img').src = shots[i].f;
  var thumbs = document.querySelectorAll('.shot-thumb');
  for (var j = 0; j < thumbs.length; j++) {
    if (j === i) { thumbs[j].classList.add('active'); }
    else { thumbs[j].classList.remove('active'); }
  }
  q('align-txt').textContent = 'Align the camera!';
  q('align-sub').textContent = shots[i].l;
}

// Capture
function capture() {
  var v = q('video');
  var c = q('cv');
  c.width = v.videoWidth;
  c.height = v.videoHeight;
  c.getContext('2d').drawImage(v, 0, 0);
  q('flash').classList.add('on');
  q('cap').classList.add('flash');
  if (navigator.vibrate) navigator.vibrate(50);
  setTimeout(function() {
    q('flash').classList.remove('on');
    q('cap').classList.remove('flash');
  }, 150);
  var url = c.toDataURL('image/jpeg', 0.92);
  var shot = OV[S.cat][S.idx];
  S.photos.push({ url:url, label:S.cat + ' - ' + shot.l, time:new Date().toLocaleTimeString() });
  updGal();
  toast('Captured: ' + shot.l);
  if (S.idx < OV[S.cat].length - 1) {
    setTimeout(function() { pickShot(S.idx + 1); }, 400);
  }
}

// Gallery
function updGal() {
  var n = S.photos.length;
  if (n > 0) {
    q('gp').style.backgroundImage = 'url(' + S.photos[n-1].url + ')';
    q('gb').style.display = 'flex';
    q('gb').textContent = n;
  } else {
    q('gp').style.backgroundImage = '';
    q('gb').style.display = 'none';
  }
}

function showGal() {
  q('gallery').classList.add('visible');
  if (S.photos.length === 0) {
    q('g-grid').innerHTML = '<div class="ge">No photos yet</div>';
  } else {
    var html = '';
    for (var i = 0; i < S.photos.length; i++) {
      html += '<div class="gi" onclick="dlP(' + i + ')">';
      html += '<img src="' + S.photos[i].url + '">';
      html += '<div class="tag">' + S.photos[i].label + '</div>';
      html += '</div>';
    }
    q('g-grid').innerHTML = html;
  }
}

function dlP(i) {
  var p = S.photos[i];
  var a = document.createElement('a');
  a.href = p.url;
  a.download = p.label.replace(/\s+/g, '_') + '_' + Date.now() + '.jpg';
  a.click();
  toast('Saved');
}

function toast(m) {
  q('toast').textContent = m;
  q('toast').classList.add('show');
  setTimeout(function() { q('toast').classList.remove('show'); }, 2000);
}

function toggleFS() {
  if (!document.fullscreenElement && !document.webkitFullscreenElement) {
    var el = document.documentElement;
    if (el.requestFullscreen) {
      el.requestFullscreen({ navigationUI: 'hide' }).then(function() {
        setTimeout(fixViewport, 100);
        toast('Fullscreen');
      }).catch(function(){
        // iOS fallback: try video fullscreen
        var v = q('video');
        if (v && v.webkitEnterFullscreen) {
          try { v.webkitEnterFullscreen(); } catch(e2) {}
        }
      });
    } else if (el.webkitRequestFullscreen) {
      el.webkitRequestFullscreen();
    } else {
      // Last resort for iOS: try video element
      var v = q('video');
      if (v && v.webkitEnterFullscreen) {
        try { v.webkitEnterFullscreen(); } catch(e) {}
      }
    }
  } else {
    if (document.exitFullscreen) document.exitFullscreen();
    else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
  }
}

// Events
q('start-btn').onclick = startCam;
q('close-btn').onclick = function() {
  if (S.stream) S.stream.getTracks().forEach(function(t){t.stop();});
  q('cam').classList.add('hidden');
  q('perm').classList.remove('hidden');
};
q('fs-btn').onclick = toggleFS;
q('sw-btn').onclick = flipCam;
q('sw2').onclick = flipCam;
q('cap').onclick = capture;
q('gp').onclick = showGal;
q('g-back').onclick = function() { q('gallery').classList.remove('visible'); };
q('g-clear').onclick = function() {
  if (confirm('Clear all photos?')) { S.photos = []; updGal(); showGal(); toast('Cleared'); }
};

q('tabs').onclick = function(e) {
  var t = e.target;
  while (t && !t.classList.contains('cat-tab')) t = t.parentElement;
  if (t && t.dataset.cat) loadCat(t.dataset.cat);
};

q('shots').onclick = function(e) {
  var t = e.target;
  while (t && !t.classList.contains('shot-thumb')) t = t.parentElement;
  if (t && t.dataset.i !== undefined) pickShot(parseInt(t.dataset.i));
};

document.onkeydown = function(e) {
  if (e.code === 'Space') { e.preventDefault(); capture(); }
  if (e.code === 'ArrowRight') pickShot(S.idx + 1);
  if (e.code === 'ArrowLeft') pickShot(S.idx - 1);
  if (e.code === 'KeyF') flipCam();
};

// ===== PHONE VIEWPORT FIX =====
// Use visualViewport to perfectly size the app to whatever Safari gives us
// This works WITH the toolbar â€” no fighting Safari
function fixViewport() {
  var vh, vw;
  if (window.visualViewport) {
    vh = window.visualViewport.height;
    vw = window.visualViewport.width;
  } else {
    vh = window.innerHeight;
    vw = window.innerWidth;
  }
  // Set CSS custom property so all elements use the real visible height
  document.documentElement.style.setProperty('--app-h', vh + 'px');
  // Also pin the offset in case Safari scrolls the viewport
  if (window.visualViewport && window.visualViewport.offsetTop > 0) {
    window.scrollTo(0, 0);
  }
}

// Listen to visualViewport changes (Safari iOS toolbar show/hide triggers this)
if (window.visualViewport) {
  window.visualViewport.addEventListener('resize', fixViewport);
  window.visualViewport.addEventListener('scroll', fixViewport);
}
window.addEventListener('resize', fixViewport);
window.addEventListener('orientationchange', function() {
  setTimeout(fixViewport, 50);
  setTimeout(fixViewport, 200);
  setTimeout(fixViewport, 500);
});

// Prevent any accidental scrolling that would show black gaps
document.addEventListener('touchmove', function(e) {
  // Allow scrolling inside shot carousel and gallery grid
  var t = e.target;
  while (t) {
    if (t.classList && (t.classList.contains('shot-carousel') || t.classList.contains('gg'))) return;
    t = t.parentElement;
  }
  e.preventDefault();
}, { passive: false });

// Initial
fixViewport();

// ===== FULLSCREEN ON CAMERA START =====
var origStartCam = startCam;
startCam = function() {
  // Try fullscreen (Chrome Android = works, iOS = won't but we try anyway)
  try {
    var el = document.documentElement;
    if (el.requestFullscreen) {
      el.requestFullscreen({ navigationUI: 'hide' }).then(function() {
        setTimeout(fixViewport, 100);
        setTimeout(fixViewport, 400);
      }).catch(function(){
        // iOS: requestFullscreen fails, just fix viewport
        fixViewport();
      });
    } else if (el.webkitRequestFullscreen) {
      el.webkitRequestFullscreen();
    }
  } catch(e) {}

  // Keep screen awake while camera is active
  try {
    if ('wakeLock' in navigator) {
      navigator.wakeLock.request('screen').catch(function(){});
    }
  } catch(e) {}

  fixViewport();
  origStartCam();
  setTimeout(fixViewport, 300);
  setTimeout(fixViewport, 800);
};

// Re-fix viewport when entering/exiting fullscreen
document.addEventListener('fullscreenchange', function() {
  setTimeout(fixViewport, 50);
  setTimeout(fixViewport, 200);
  setTimeout(fixViewport, 500);
});
document.addEventListener('webkitfullscreenchange', function() {
  setTimeout(fixViewport, 50);
  setTimeout(fixViewport, 200);
});

// ===== PWA INSTALL BANNER =====
(function() {
  var ua = navigator.userAgent;
  var isIOS = /iPad|iPhone|iPod/.test(ua);
  var isChromeIOS = /CriOS/.test(ua);
  var isSafariIOS = isIOS && /Safari/.test(ua) && !isChromeIOS && !/FxiOS|EdgiOS/.test(ua);
  var isAndroid = /Android/.test(ua);
  var isStandalone = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches || window.matchMedia('(display-mode: fullscreen)').matches;
  var dismissed = localStorage.getItem('pwa-dismissed');
  var savedPrompt = null;

  function showBanner(title, msg) {
    if (dismissed || isStandalone) return;
    q('pwa-title').textContent = title;
    q('pwa-msg').textContent = msg;
    setTimeout(function() {
      q('pwa-banner').style.display = 'block';
    }, 2500);
  }

  // iOS Safari: "Add to Home Screen" from share menu
  if (isSafariIOS && !isStandalone && !dismissed) {
    showBanner('Go Fullscreen', 'Tap Share â†— then "Add to Home Screen" for no browser bars!');
  }

  // Chrome on iPhone: can't do fullscreen, suggest opening in Safari to add to home screen
  if (isChromeIOS && !isStandalone && !dismissed) {
    showBanner('For best experience', 'Open in Safari â†’ Share â†— â†’ "Add to Home Screen" for fullscreen mode. Or tap â›¶ to try fullscreen.');
  }

  // Chrome Android: native install prompt
  window.addEventListener('beforeinstallprompt', function(e) {
    e.preventDefault();
    savedPrompt = e;
    if (!dismissed && !isStandalone) {
      showBanner('Install App', 'Install for fullscreen with no browser bars!');
    }
  });

  q('pwa-dismiss').onclick = function() {
    q('pwa-banner').style.display = 'none';
    localStorage.setItem('pwa-dismissed', '1');
    // If we have a Chrome install prompt, trigger it
    if (savedPrompt) {
      savedPrompt.prompt();
      savedPrompt = null;
    }
  };
})();

// ===== LOCK LANDSCAPE HINT =====
screen.orientation && screen.orientation.lock && screen.orientation.lock('landscape').catch(function(){});

// ===== SERVICE WORKER (required for Chrome PWA install) =====
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(function(){});
}

// ===== PERMISSION SCREEN TIP =====
(function() {
  var ua = navigator.userAgent;
  var tip = q('perm-tip');
  var isIOS = /iPad|iPhone|iPod/.test(ua);
  var isChromeIOS = /CriOS/.test(ua);
  var isStandalone = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches || window.matchMedia('(display-mode: fullscreen)').matches;

  if (isStandalone) {
    tip.textContent = 'âœ“ Running in fullscreen mode';
    tip.style.color = 'rgba(100,255,100,0.5)';
  } else if (isChromeIOS) {
    tip.textContent = 'Tip: Open in Safari â†’ Add to Home Screen for fullscreen';
  } else if (isIOS) {
    tip.textContent = 'Tip: Add to Home Screen for fullscreen (no bars)';
  } else {
    tip.textContent = 'Opens in fullscreen';
  }
})();
</script>
</body>
</html>
